<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Usuarios</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
  </head>

  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <h4>Usuarios</h4>

        <div class="row">
          <form method="GET" class="col s12 m8">
            <div class="input-field">
              <i class="material-icons prefix">search</i>
              <input
                id="termino"
                type="text"
                name="q"
                value="{{ termino }}"
                placeholder="Buscar por nombre, correo o documento"
              />
              <label for="termino">Buscar usuario</label>
            </div>
            <button class="btn blue waves-effect" type="submit">Buscar</button>
            {% if termino %}
            <a
              href="{{ url_for('usuarios.listar') }}"
              class="btn grey lighten-1 black-text"
              >Limpiar</a
            >
            {% endif %}
          </form>
          <div class="col s12 m4 right-align" style="margin-top: 24px">
            <a
              href="{{ url_for('usuarios.listar') }}"
              class="btn green waves-effect"
            >
              <i class="material-icons left">person_add</i>
              Nuevo usuario
            </a>
          </div>
        </div>

        <div class="card">
          <div class="card-content">
            <span class="card-title"
              >{{ 'Editar usuario' if usuario_editar else 'Nuevo usuario'
              }}</span
            >
            <form method="POST" action="{{ url_for('usuarios.guardar') }}">
              {{ form.hidden_tag() }}
              <div class="row">
                <div class="input-field col s12 m6">
                  {{ form.nombres.label }} {{ form.nombres(class="validate") }}
                </div>
                <div class="input-field col s12 m6">
                  {{ form.apellidos.label }} {{ form.apellidos(class="validate")
                  }}
                </div>
                <div class="input-field col s12 m6">
                  {{ form.email.label }} {{ form.email(class="validate") }}
                </div>
                <div class="input-field col s12 m6">
                  {{ form.numero_documento.label }} {{
                  form.numero_documento(class="validate") }}
                </div>
                <div class="input-field col s12 m6">
                  {{ form.id_institucion.label }} {{
                  form.id_institucion(class="browser-default") }}
                </div>
                <div class="input-field col s12 m6">
                  {{ form.id_perfil.label }} {{
                  form.id_perfil(class="browser-default") }}
                </div>
              </div>
              <div class="row">
                <div class="col s12 m4">
                  <label>
                    {{ form.estado() }}
                    <span>{{ form.estado.label.text }}</span>
                  </label>
                </div>
                <div class="col s12 m4">
                  <label>
                    {{ form.geoidep() }}
                    <span>{{ form.geoidep.label.text }}</span>
                  </label>
                </div>
                <div class="col s12 m4">
                  <label>
                    {{ form.geoperu() }}
                    <span>{{ form.geoperu.label.text }}</span>
                  </label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12 m6">
                  {{ form.password.label }} {{ form.password(class="validate")
                  }}
                  <span class="helper-text">
                    {% if usuario_editar %} Deja el campo vacío para mantener la
                    contraseña actual. {% else %} Ingresa una contraseña
                    temporal para el nuevo usuario. {% endif %}
                  </span>
                </div>
              </div>
              <div class="row">
                <div class="col s12 right-align">
                  <button type="submit" class="btn blue waves-effect">
                    <i class="material-icons left">save</i>
                    Guardar
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-content">
            <span class="card-title">Listado de usuarios</span>
            <div class="table-responsive">
              <table class="highlight" style="background-color: #fff">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Nombres</th>
                    <th>Apellidos</th>
                    <th>Correo</th>
                    <th>Documento</th>
                    <th>Perfil</th>
                    <th>Institución</th>
                    <th>GeoIDEP</th>
                    <th>GeoPerú</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for usuario in usuarios %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ usuario.nombres or '-' }}</td>
                    <td>{{ usuario.apellidos or '-' }}</td>
                    <td>{{ usuario.email }}</td>
                    <td>{{ usuario.numero_documento or '-' }}</td>
                    <td>
                      {{ usuario.perfil.nombre if usuario.perfil else '-' }}
                    </td>
                    <td>
                      {{ usuario.institucion.nombre if usuario.institucion else
                      '-' }}
                    </td>
                    <td>{{ 'Sí' if usuario.geoidep else 'No' }}</td>
                    <td>{{ 'Sí' if usuario.geoperu else 'No' }}</td>
                    <td>{{ 'Activo' if usuario.estado else 'Inactivo' }}</td>
                    <td>
                      <a
                        href="{{ url_for('usuarios.listar', editar=usuario.id, q=termino) }}"
                        class="btn-small waves-effect blue"
                      >
                        <i class="material-icons">edit</i>
                      </a>
                      <form
                        method="POST"
                        action="{{ url_for('usuarios.eliminar', id_usuario=usuario.id) }}"
                        style="display: inline"
                        onsubmit="return confirm('¿Desea eliminar al usuario {{ usuario.nombre_completo }}?');"
                      >
                        {{ delete_form.hidden_tag() }}
                        <button
                          class="btn-small red waves-effect"
                          type="submit"
                        >
                          <i class="material-icons">delete</i>
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="11" class="center-align">
                      No se encontraron usuarios con los criterios ingresados.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const msgs = {{ get_flashed_messages(with_categories = true) | tojson }};
        msgs.forEach(([category, msg]) => {
          const classes = category === 'success' ? 'green'
            : category === 'error' ? 'red'
              : category === 'warning' ? 'orange'
                : '';
          M.toast({ html: msg, classes });
        });
      });
    </script>
  </body>
</html>
