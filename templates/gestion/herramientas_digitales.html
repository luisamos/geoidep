<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GEOIDEP | Herramientas digitales</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .icono-tabla {
        width: 32px;
        height: 32px;
        cursor: pointer;
      }

      .estado-icono {
        font-size: 1.3rem;
        display: inline-block;
      }

      .tabla-herramientas {
        background-color: #fff;
        width: 100%;
      }

      .tabla-herramientas th,
      .tabla-herramientas td {
        vertical-align: middle;
        word-break: break-word;
      }

      .tabla-herramientas .col-indice {
        width: 40px;
      }

      .tabla-herramientas .col-categoria,
      .tabla-herramientas .col-tipo {
        width: 140px;
        white-space: normal;
      }

      .tabla-herramientas .col-nombre,
      .tabla-herramientas .col-institucion {
        max-width: 200px;
      }

      .tabla-herramientas .col-estado {
        width: 90px;
        text-align: center;
      }

      .tabla-herramientas .col-opciones {
        width: 150px;
      }

      .icono-tabla.inferior {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <div class="row">
          <div class="col s12">
            <h3>Herramientas digitales</h3>
            <p class="flow-text">
              Acceso a los recursos geoespaciales de la Infraestructura de Datos
              Espaciales del Perú.
            </p>
          </div>
          <div class="input-field col s12 m4 l3">
            <select id="filtro_tipo">
              <option value="" selected>Todos los tipos</option>
              {% for tipo in tipos_servicio %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
            <label>Tipo de recurso</label>
          </div>
          <div class="input-field col s12 m4 l4">
            <input
              id="txtFiltro"
              type="text"
              class="validate"
              placeholder="Ingrese el nombre del recurso"
            />
            <label for="txtFiltro">Nombre del recurso</label>
          </div>
          <div class="col s6 m2 l2">
            <button id="btnBuscar" class="btn btn-small blue" type="button">
              <i class="material-icons left">search</i> Buscar
            </button>
          </div>
        </div>

        <div class="row">
          <div class="estado-filtros">
            <span class="grey-text text-darken-2">Estados visibles</span>
            <div class="switch">
              <label>
                Inactivo
                <input type="checkbox" id="switchActivos" checked />
                <span class="lever"></span>
                Activo
              </label>
            </div>
          </div>
          <div class="right">
            <button
              id="btnAgregar"
              class="btn waves-light btn-small green"
              data-target="modalHerramienta"
              type="button"
            >
              <i class="material-icons left">add</i>Nuevo
            </button>
          </div>
        </div>

        <div class="row" style="max-height: 600px; overflow-y: auto">
          <div class="col s12">
            <table class="highlight tabla-herramientas" id="tablaHerramientas">
              <thead>
                <tr>
                  <th class="col-indice" style="padding-left: 20px">N°</th>
                  <th class="col-categoria">Categoría</th>
                  <th class="col-tipo">Tipo de recurso</th>
                  <th class="col-nombre">Nombre</th>
                  <th class="col-estado">Estado</th>
                  <th class="col-institucion">Institución</th>
                  <th class="col-opciones">Opciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      id="institucionTag"
      data-institucion-id="{{ institucion_usuario.id if institucion_usuario else '' }}"
      data-institucion-nombre="{{ institucion_usuario.nombre if institucion_usuario else '' }}"
      hidden
    ></div>

    <div id="modalHerramienta" class="modal">
      <div class="modal-content">
        <div
          class="row center"
          style="border-bottom: 3px solid rgba(1, 11, 100, 0.14)"
        >
          <h5 id="modalTituloHerramienta">NUEVA HERRAMIENTA DIGITAL</h5>
          <img
            id="imgClose_modal_layer"
            alt="Cerrar ventana"
            src="{{ url_for('static', filename='images/close.png') }}"
            style="position: absolute; right: 10px; top: 10px"
          />
        </div>
        <form id="formHerramienta">
          <div class="input-field">
            <input id="nombre_herramienta" type="text" maxlength="200" />
            <label for="nombre_herramienta">Nombre</label>
          </div>

          <div class="input-field">
            <input id="descripcion_herramienta" type="text" maxlength="800" />
            <label for="descripcion_herramienta">Descripción (opcional)</label>
          </div>

          <div class="input-field">
            <select id="tipo_servicio_herramienta">
              <option value="" disabled selected>Seleccione tipo</option>
              {% for tipo in tipos_servicio %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
            <label>Tipo de recurso</label>
          </div>

          <div class="input-field">
            <select id="categoria_herramienta">
              <option value="" disabled selected>Seleccione categoría</option>
              {% for categoria in categorias %}
              <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
              {% endfor %}
            </select>
            <label>Categoría</label>
          </div>

          <p>
            <strong>Institución:</strong>
            <span id="institucionNombre">
              {{ institucion_usuario.nombre if institucion_usuario else 'No
              asociada' }}
            </span>
          </p>

          <div class="input-field">
            <input id="recurso_herramienta" type="url" />
            <label for="recurso_herramienta">URL del recurso (opcional)</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="modal-close btn-flat" type="button">Cancelar</button>
        <button class="btn blue" id="btnGuardar" type="button">Guardar</button>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const modalElems = document.querySelectorAll(".modal");
        M.Modal.init(modalElems);
        inicializarSelects();

        const tbody = document.querySelector("#tablaHerramientas tbody");
        const switchActivos = document.getElementById("switchActivos");

        cargarHerramientas();

        document
          .getElementById("btnBuscar")
          .addEventListener("click", cargarHerramientas);
        document
          .getElementById("filtro_tipo")
          .addEventListener("change", renderHerramientas);
        document
          .getElementById("txtFiltro")
          .addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
              cargarHerramientas();
            }
          });
        if (switchActivos) {
          switchActivos.addEventListener("change", renderHerramientas);
        }
        document
          .getElementById("btnAgregar")
          .addEventListener("click", function () {
            document.getElementById("formHerramienta").reset();
            herramientaEditandoId = null;
            document.getElementById("modalTituloHerramienta").textContent =
              "NUEVA HERRAMIENTA DIGITAL";
            setTimeout(() => {
              inicializarSelects();
              M.updateTextFields();
            }, 0);
          });

        document
          .getElementById("btnGuardar")
          .addEventListener("click", function (event) {
            event.preventDefault();
            guardarHerramienta();
          });
        tbody.addEventListener("click", manejarAccionesTabla);
      });

      function inicializarSelects() {
        const selectElems = document.querySelectorAll("select");
        selectElems.forEach((elem) => {
          const instancia = M.FormSelect.getInstance(elem);
          if (instancia) {
            instancia.destroy();
          }
          M.FormSelect.init(elem);
        });
      }

      const iconoEnlace =
        "{{ url_for('static', filename='images/enlace.png') }}";
      const iconoEditar = "{{ url_for('static', filename='images/edit.png') }}";
      const iconoEliminar =
        "{{ url_for('static', filename='images/delete.png') }}";
      let herramientasCache = { activos: [], inactivos: [], sin_estado: [] };
      let herramientaEditandoId = null;

      async function cargarHerramientas() {
        try {
          const resp = await fetch("/herramientas_digitales/listar");
          if (!resp.ok) {
            throw new Error("No se pudo obtener la información");
          }
          const data = await resp.json();
          herramientasCache = {
            activos: Array.isArray(data.activos) ? data.activos : [],
            inactivos: Array.isArray(data.inactivos) ? data.inactivos : [],
            sin_estado: Array.isArray(data.sin_estado) ? data.sin_estado : [],
          };
          renderHerramientas();
        } catch (err) {
          M.toast({
            html: err.message || "Ocurrió un error al listar las herramientas",
          });
        }
      }

      function renderHerramientas() {
        const tbody = document.querySelector("#tablaHerramientas tbody");
        if (!tbody) {
          return;
        }

        const filtroNombre = document
          .getElementById("txtFiltro")
          .value.trim()
          .toLowerCase();
        const filtroTipo = document.getElementById("filtro_tipo").value;
        const mostrarActivos =
          document.getElementById("switchActivos")?.checked ?? true;

        let registros = [];
        if (mostrarActivos) {
          registros = registros.concat(herramientasCache.activos || []);
        }

        const filtrados = registros.filter((item) => {
          const nombre = (item.nombre || "").toLowerCase();
          const coincideNombre = !filtroNombre || nombre.includes(filtroNombre);
          const coincideTipo =
            !filtroTipo || Number(item.id_tipo_servicio) === Number(filtroTipo);
          return coincideNombre && coincideTipo;
        });

        tbody.innerHTML = "";

        if (filtrados.length === 0) {
          const fila = document.createElement("tr");
          fila.innerHTML =
            '<td colspan="7">No hay herramientas registradas.</td>';
          tbody.appendChild(fila);
          return;
        }

        filtrados.forEach((herramienta, index) => {
          const fila = document.createElement("tr");
          const categoria =
            herramienta.categoria != null
              ? escaparHtml(herramienta.categoria)
              : "-";
          const tipoServicio =
            herramienta.tipo_servicio != null
              ? escaparHtml(herramienta.tipo_servicio)
              : "-";
          const nombre = escaparHtml(herramienta.nombre || "");
          const institucion =
            herramienta.institucion != null
              ? escaparHtml(herramienta.institucion)
              : "-";
          const estadoIcono = herramienta.estado_icono || "⚪";
          const estadoTexto = herramienta.estado_display || "Sin estado";
          const estadoTooltip = escaparHtml(estadoTexto);

          fila.innerHTML = `
            <td class="col-indice" style="padding-left: 20px">${index + 1}</td>
            <td class="col-categoria">${categoria}</td>
            <td class="col-tipo">${tipoServicio}</td>
            <td class="col-nombre">${nombre}</td>
            <td class="col-estado">
              <span class="estado-icono" title="${estadoTooltip}">${estadoIcono}</span>
            </td>
            <td class="col-institucion">${institucion}</td>
            <td class="col-opciones">
                  <img
                    src="${iconoEnlace}"
                    class="icono-tabla accion-enlace"
                    alt="Ir al recurso"
                    title="Ir al recurso"
                  />
                  <img
                    src="${iconoEditar}"
                    class="icono-tabla accion-editar"
                    data-id="${herramienta.id}"
                    alt="Editar"
                    title="Editar"
                  />
                  <img
                    src="${iconoEliminar}"
                    class="icono-tabla accion-eliminar"
                    data-id="${herramienta.id}"
                    alt="Eliminar"
                    title="Eliminar"
                  />
              </div>
            </td>
          `;

          const iconoRecurso = fila.querySelector(".accion-enlace");
          if (iconoRecurso) {
            iconoRecurso.dataset.recurso = herramienta.recurso || "";
          }

          tbody.appendChild(fila);
        });
      }

      function buscarHerramientaPorId(id) {
        const conjuntos = [
          herramientasCache.activos,
          herramientasCache.inactivos,
          herramientasCache.sin_estado,
        ];
        for (const lista of conjuntos) {
          if (!Array.isArray(lista)) {
            continue;
          }
          const encontrada = lista.find((item) => Number(item.id) === id);
          if (encontrada) {
            return encontrada;
          }
        }
        return null;
      }

      function escaparHtml(texto) {
        const div = document.createElement("div");
        div.textContent = texto;
        return div.innerHTML;
      }

      async function guardarHerramienta() {
        const nombre = document
          .getElementById("nombre_herramienta")
          .value.trim();
        const descripcion = document
          .getElementById("descripcion_herramienta")
          .value.trim();
        const tipoServicio = document.getElementById(
          "tipo_servicio_herramienta"
        ).value;
        const categoria = document.getElementById(
          "categoria_herramienta"
        ).value;
        const recurso = document
          .getElementById("recurso_herramienta")
          .value.trim();

        const institucionTag = document.getElementById("institucionTag");
        const institucionId = institucionTag
          ? Number(institucionTag.dataset.institucionId || 0)
          : 0;

        const esEdicion = Boolean(herramientaEditandoId);

        if (!nombre || !tipoServicio || !categoria) {
          M.toast({ html: "Complete los campos obligatorios." });
          return;
        }

        if (!institucionId) {
          M.toast({
            html: "No se encontró la institución asociada al usuario.",
          });
          return;
        }

        const payload = {
          nombre: nombre,
          id_tipo_servicio: Number(tipoServicio),
          id_categoria: Number(categoria),
          descripcion: descripcion,
          recurso: recurso,
        };

        if (!esEdicion) {
          payload.id_institucion = institucionId;
        }

        try {
          const url = esEdicion
            ? `/herramientas_digitales/${herramientaEditandoId}`
            : "/herramientas_digitales/guardar";
          const method = esEdicion ? "PUT" : "POST";
          const resp = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const resultado = await resp.json();

          if (!resp.ok) {
            throw new Error(
              resultado.message ||
                (esEdicion
                  ? "No se pudo actualizar la herramienta"
                  : "No se pudo registrar la herramienta")
            );
          }

          const mensajeExito = esEdicion
            ? "Herramienta actualizada correctamente"
            : "Herramienta registrada correctamente";
          M.toast({ html: mensajeExito });
          const modal = M.Modal.getInstance(
            document.getElementById("modalHerramienta")
          );
          modal.close();
          document.getElementById("formHerramienta").reset();
          inicializarSelects();
          M.updateTextFields();
          document.getElementById("modalTituloHerramienta").textContent =
            "NUEVA HERRAMIENTA DIGITAL";
          herramientaEditandoId = null;
          cargarHerramientas();
        } catch (err) {
          M.toast({ html: err.message || "Error al guardar la herramienta" });
        }
      }

      function manejarAccionesTabla(event) {
        const target = event.target;
        if (target.classList.contains("accion-enlace")) {
          const recurso = target.dataset.recurso;
          if (!recurso) {
            M.toast({ html: "La herramienta no tiene un recurso disponible." });
            return;
          }
          window.open(recurso, "_blank", "noopener");
          return;
        }

        if (target.classList.contains("accion-editar")) {
          const id = Number(target.dataset.id);
          const herramienta = buscarHerramientaPorId(id);
          if (!herramienta) {
            M.toast({
              html: "No se encontró la información de la herramienta",
            });
            return;
          }
          abrirModalEdicion(herramienta);
        } else if (target.classList.contains("accion-eliminar")) {
          const id = Number(target.dataset.id);
          eliminarHerramienta(id);
        }
      }

      function abrirModalEdicion(herramienta) {
        herramientaEditandoId = herramienta.id;
        document.getElementById("modalTituloHerramienta").textContent =
          "EDITAR HERRAMIENTA DIGITAL";

        document.getElementById("nombre_herramienta").value =
          herramienta.nombre || "";
        document.getElementById("descripcion_herramienta").value =
          herramienta.descripcion || "";
        establecerValorSelect(
          "tipo_servicio_herramienta",
          herramienta.id_tipo_servicio
        );
        establecerValorSelect(
          "categoria_herramienta",
          herramienta.id_categoria
        );
        document.getElementById("recurso_herramienta").value =
          herramienta.recurso || "";

        inicializarSelects();
        M.updateTextFields();

        const modal = M.Modal.getInstance(
          document.getElementById("modalHerramienta")
        );
        modal.open();
      }

      function establecerValorSelect(idSelect, valor) {
        const select = document.getElementById(idSelect);
        if (!select) {
          return;
        }
        select.value = valor == null ? "" : String(valor);
        const instanciaExistente = M.FormSelect.getInstance(select);
        if (instanciaExistente) {
          instanciaExistente.destroy();
        }
        M.FormSelect.init(select);
      }

      async function eliminarHerramienta(id) {
        const confirmar = confirm(
          "¿Está seguro de eliminar la herramienta seleccionada?"
        );
        if (!confirmar) {
          return;
        }

        try {
          const resp = await fetch(`/herramientas_digitales/${id}`, {
            method: "DELETE",
          });
          const resultado = await resp.json();

          if (!resp.ok) {
            throw new Error(
              resultado.message || "No se pudo eliminar la herramienta"
            );
          }

          M.toast({ html: "Herramienta eliminada correctamente" });
          cargarHerramientas();
        } catch (err) {
          M.toast({ html: err.message || "Error al eliminar la herramienta" });
        }
      }
    </script>
  </body>
</html>
