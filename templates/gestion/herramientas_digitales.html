<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GEOIDEP | Herramientas digitales</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .icono-tabla {
        width: 32px;
        height: 32px;
        cursor: pointer;
      }

      .estado-icono {
        font-size: 1.3rem;
        display: inline-block;
      }

      .tabla-herramientas {
        background-color: #fff;
        width: 100%;
      }

      .tabla-herramientas th,
      .tabla-herramientas td {
        vertical-align: middle;
        word-break: break-word;
      }

      .tabla-herramientas .col-indice {
        width: 40px;
      }

      .tabla-herramientas .col-categoria,
      .tabla-herramientas .col-tipo {
        width: 140px;
        white-space: normal;
      }

      .tabla-herramientas .col-nombre,
      .tabla-herramientas .col-institucion {
        max-width: 200px;
      }

      .tabla-herramientas .col-estado {
        width: 90px;
        text-align: center;
      }

      .tabla-herramientas .col-opciones {
        width: 150px;
      }

      .icono-tabla.inferior {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <div class="row">
          <div class="col s12">
            <h3>Herramientas digitales</h3>
            <p class="flow-text">
              Acceso a los recursos geoespaciales de la Infraestructura de Datos
              Espaciales del Perú.
            </p>
          </div>
          <div class="input-field col s12 m4 l3">
            <select id="filtro_tipo">
              <option value="" selected>Todos los tipos</option>
              {% for tipo in tipos_servicio %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
            <label>Tipo de recurso</label>
          </div>
          <div class="input-field col s12 m4 l4">
            <input
              id="txtFiltro"
              type="text"
              class="validate"
              placeholder="Ingrese el nombre del recurso"
            />
            <label for="txtFiltro">Nombre del recurso</label>
          </div>
          <div class="col s6 m2 l2">
            <button id="btnBuscar" class="btn btn-small blue" type="button">
              <i class="material-icons left">search</i> Buscar
            </button>
          </div>
        </div>

        <div class="row">
          <div class="estado-filtros">
            <span class="grey-text text-darken-2">Estados visibles</span>
            <div class="switch">
              <label>
                Inactivo
                <input type="checkbox" id="switchActivos" checked />
                <span class="lever"></span>
                Activo
              </label>
            </div>
          </div>
          <div class="right">
            <button
              id="btnAgregar"
              class="btn waves-light btn-small green"
              data-target="modalHerramienta"
              type="button"
            >
              <i class="material-icons left">add</i>Nuevo
            </button>
          </div>
        </div>

        <div class="row" style="max-height: 600px; overflow-y: auto">
          <div class="col s12">
            <table class="highlight tabla-herramientas" id="tablaHerramientas">
              <thead>
                <tr>
                  <th class="col-indice" style="padding-left: 20px">N°</th>
                  <th class="col-categoria">Categoría</th>
                  <th class="col-tipo">Tipo de recurso</th>
                  <th class="col-nombre">Nombre</th>
                  <th class="col-estado">Estado</th>
                  <th class="col-institucion">Institución</th>
                  <th class="col-opciones">Opciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      id="institucionTag"
      data-institucion-id="{{ institucion_usuario.id if institucion_usuario else '' }}"
      data-institucion-nombre="{{ institucion_usuario.nombre if institucion_usuario else '' }}"
      hidden
    ></div>

    <div id="modalHerramienta" class="modal">
      <div class="modal-content">
        <div
          class="row center"
          style="border-bottom: 3px solid rgba(1, 11, 100, 0.14)"
        >
          <h5 id="modalTituloHerramienta">NUEVA HERRAMIENTA DIGITAL</h5>
          <img
            id="imgClose_modal_layer"
            alt="Cerrar ventana"
            src="{{ url_for('static', filename='images/close.png') }}"
            style="position: absolute; right: 10px; top: 10px"
          />
        </div>
        <form id="formHerramienta">
          <div class="input-field">
            <input id="nombre_herramienta" type="text" maxlength="200" />
            <label for="nombre_herramienta">Nombre</label>
          </div>

          <div class="input-field">
            <textarea
              id="descripcion_herramienta"
              class="materialize-textarea"
              maxlength="800"
            ></textarea>
            <label for="descripcion_herramienta">Descripción (opcional)</label>
          </div>

          <div class="input-field">
            <select id="tipo_servicio_herramienta">
              <option value="" disabled selected>Seleccione tipo</option>
              {% for tipo in tipos_servicio %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
            <label>Tipo de recurso</label>
          </div>

          <div class="input-field">
            <select id="categoria_herramienta">
              <option value="" disabled selected>Seleccione categoría</option>
              {% for categoria in categorias %}
              <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
              {% endfor %}
            </select>
            <label>Categoría</label>
          </div>

          <p>
            <strong>Institución:</strong>
            <span id="institucionNombre">
              {{ institucion_usuario.nombre if institucion_usuario else 'No
              asociada' }}
            </span>
          </p>

          <div class="input-field">
            <input id="recurso_herramienta" type="url" />
            <label for="recurso_herramienta">URL del recurso (opcional)</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="modal-close btn-flat" type="button">Cancelar</button>
        <button class="btn blue" id="btnGuardar" type="button">Guardar</button>
      </div>
    </div>

    <div id="modalConfirmacion" class="modal">
      <div class="modal-content center-align">
        <h6 id="mensajeModalConfirmacion">
          ¿Está seguro que desea eliminar el registro?
        </h6>
      </div>
      <div class="modal-footer">
        <button
          id="btnEliminarCancelar"
          class="modal-close btn-flat"
          type="button"
        >
          Cancelar
        </button>
        <button id="btnEliminarProceder" class="btn red" type="button">
          Aceptar
        </button>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
    <script>
      const iconoEnlace =
        "{{ url_for('static', filename='images/enlace.png') }}";
      const iconoEditar = "{{ url_for('static', filename='images/edit.png') }}";
      const iconoEliminar =
        "{{ url_for('static', filename='images/delete.png') }}";

      const ui = {
        tablaHerramientasBody: null,
        btnBuscar: null,
        filtroTipo: null,
        txtFiltro: null,
        switchActivos: null,
        btnAgregar: null,
        formHerramienta: null,
        modalTituloHerramienta: null,
        btnGuardar: null,
        modalHerramienta: null,
        nombreHerramienta: null,
        descripcionHerramienta: null,
        tipoServicioHerramienta: null,
        categoriaHerramienta: null,
        recursoHerramienta: null,
        institucionTag: null,
        modalConfirmacion: null,
        btnEliminarProceder: null,
        btnEliminarCancelar: null,
        imgCloseModalLayer: null,
      };

      let herramientasCache = { activos: [], inactivos: [], sin_estado: [] };
      let herramientaEditandoId = null;
      let herramientaEliminandoId = null;

      document.addEventListener("DOMContentLoaded", function () {
        ui.tablaHerramientasBody = document.querySelector(
          "#tablaHerramientas tbody"
        );
        ui.btnBuscar = document.getElementById("btnBuscar");
        ui.filtroTipo = document.getElementById("filtro_tipo");
        ui.txtFiltro = document.getElementById("txtFiltro");
        ui.switchActivos = document.getElementById("switchActivos");
        ui.btnAgregar = document.getElementById("btnAgregar");
        ui.formHerramienta = document.getElementById("formHerramienta");
        ui.modalTituloHerramienta = document.getElementById(
          "modalTituloHerramienta"
        );
        ui.btnGuardar = document.getElementById("btnGuardar");
        ui.modalHerramienta = document.getElementById("modalHerramienta");
        ui.nombreHerramienta = document.getElementById("nombre_herramienta");
        ui.descripcionHerramienta = document.getElementById(
          "descripcion_herramienta"
        );
        ui.tipoServicioHerramienta = document.getElementById(
          "tipo_servicio_herramienta"
        );
        ui.categoriaHerramienta = document.getElementById(
          "categoria_herramienta"
        );
        ui.recursoHerramienta = document.getElementById("recurso_herramienta");
        ui.institucionTag = document.getElementById("institucionTag");
        ui.modalConfirmacion = document.getElementById("modalConfirmacion");
        ui.btnEliminarProceder = document.getElementById("btnEliminarProceder");
        ui.btnEliminarCancelar = document.getElementById("btnEliminarCancelar");
        ui.imgCloseModalLayer = document.getElementById("imgClose_modal_layer");

        const modalElems = document.querySelectorAll(".modal");
        M.Modal.init(modalElems);
        inicializarSelects();

        if (ui.btnBuscar) {
          ui.btnBuscar.addEventListener("click", cargarHerramientas);
        }

        if (ui.filtroTipo) {
          ui.filtroTipo.addEventListener("change", renderHerramientas);
        }

        if (ui.txtFiltro) {
          ui.txtFiltro.addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
              cargarHerramientas();
            }
          });
        }

        if (ui.switchActivos) {
          ui.switchActivos.addEventListener("change", renderHerramientas);
        }

        if (ui.btnAgregar) {
          ui.btnAgregar.addEventListener("click", function () {
            if (ui.formHerramienta) {
              ui.formHerramienta.reset();
            }
            herramientaEditandoId = null;
            if (ui.modalTituloHerramienta) {
              ui.modalTituloHerramienta.textContent =
                "NUEVA HERRAMIENTA DIGITAL";
            }
            const modal = obtenerInstanciaModal(ui.modalHerramienta);
            modal?.open();
            setTimeout(() => {
              inicializarSelects();
              M.updateTextFields();
              if (ui.descripcionHerramienta) {
                ui.descripcionHerramienta.value = "";
                M.textareaAutoResize(ui.descripcionHerramienta);
              }
            }, 0);
          });
        }

        if (ui.imgCloseModalLayer) {
          ui.imgCloseModalLayer.style.cursor = "pointer";
          ui.imgCloseModalLayer.addEventListener("click", () => {
            const modal = obtenerInstanciaModal(ui.modalHerramienta);
            modal?.close();
          });
        }

        if (ui.btnGuardar) {
          ui.btnGuardar.addEventListener("click", function (event) {
            event.preventDefault();
            guardarHerramienta();
          });
        }

        if (ui.tablaHerramientasBody) {
          ui.tablaHerramientasBody.addEventListener(
            "click",
            manejarAccionesTabla
          );
        }

        if (ui.btnEliminarProceder) {
          ui.btnEliminarProceder.addEventListener(
            "click",
            confirmarEliminacion
          );
        }

        if (ui.btnEliminarCancelar) {
          ui.btnEliminarCancelar.addEventListener("click", () => {
            herramientaEliminandoId = null;
          });
        }

        if (ui.descripcionHerramienta) {
          M.textareaAutoResize(ui.descripcionHerramienta);
        }

        cargarHerramientas();
      });

      function inicializarSelects() {
        const selectElems = document.querySelectorAll("select");
        selectElems.forEach((elem) => {
          const instancia = M.FormSelect.getInstance(elem);
          if (instancia) {
            instancia.destroy();
          }
          M.FormSelect.init(elem);
        });
      }

      async function cargarHerramientas() {
        try {
          const resp = await fetch("/herramientas_digitales/listar");
          if (!resp.ok) {
            throw new Error("No se pudo obtener la información");
          }
          const data = await resp.json();
          herramientasCache = {
            activos: Array.isArray(data.activos) ? data.activos : [],
            inactivos: Array.isArray(data.inactivos) ? data.inactivos : [],
            sin_estado: Array.isArray(data.sin_estado) ? data.sin_estado : [],
          };
          renderHerramientas();
        } catch (err) {
          M.toast({
            html: err.message || "Ocurrió un error al listar las herramientas",
          });
        }
      }

      function renderHerramientas() {
        const tbody = ui.tablaHerramientasBody;
        if (!tbody) {
          return;
        }

        const filtroNombre = (ui.txtFiltro?.value || "").trim().toLowerCase();
        const filtroTipo = ui.filtroTipo ? ui.filtroTipo.value : "";
        const mostrarActivos = ui.switchActivos
          ? ui.switchActivos.checked
          : true;

        let registros = [];
        if (mostrarActivos) {
          registros = registros.concat(herramientasCache.activos || []);
        }

        const filtrados = registros.filter((item) => {
          const nombre = (item.nombre || "").toLowerCase();
          const coincideNombre = !filtroNombre || nombre.includes(filtroNombre);
          const coincideTipo =
            !filtroTipo || Number(item.id_tipo_servicio) === Number(filtroTipo);
          return coincideNombre && coincideTipo;
        });

        tbody.innerHTML = "";

        if (filtrados.length === 0) {
          const fila = document.createElement("tr");
          fila.innerHTML =
            '<td colspan="7">No hay herramientas registradas.</td>';
          tbody.appendChild(fila);
          return;
        }

        filtrados.forEach((herramienta, index) => {
          const fila = document.createElement("tr");
          const categoria =
            herramienta.categoria != null
              ? escaparHtml(herramienta.categoria)
              : "-";
          const tipoServicio =
            herramienta.tipo_servicio != null
              ? escaparHtml(herramienta.tipo_servicio)
              : "-";
          const nombre = escaparHtml(herramienta.nombre || "");
          const institucion =
            herramienta.institucion != null
              ? escaparHtml(herramienta.institucion)
              : "-";
          const estadoIcono = herramienta.estado_icono || "⚪";
          const estadoTexto = herramienta.estado_display || "Sin estado";
          const estadoTooltip = escaparHtml(estadoTexto);

          fila.innerHTML = `
            <td class="col-indice" style="padding-left: 20px">${index + 1}</td>
            <td class="col-categoria">${categoria}</td>
            <td class="col-tipo">${tipoServicio}</td>
            <td class="col-nombre">${nombre}</td>
            <td class="col-estado">
              <span class="estado-icono" title="${estadoTooltip}">${estadoIcono}</span>
            </td>
            <td class="col-institucion">${institucion}</td>
            <td class="col-opciones">
                  <img
                    src="${iconoEnlace}"
                    class="icono-tabla accion-enlace"
                    alt="Ir al recurso"
                    title="Ir al recurso"
                  />
                  <img
                    src="${iconoEditar}"
                    class="icono-tabla accion-editar"
                    data-id="${herramienta.id}"
                    alt="Editar"
                    title="Editar"
                  />
                  <img
                    src="${iconoEliminar}"
                    class="icono-tabla accion-eliminar"
                    data-id="${herramienta.id}"
                    alt="Eliminar"
                    title="Eliminar"
                  />
              </div>
            </td>
          `;

          const iconoRecurso = fila.querySelector(".accion-enlace");
          if (iconoRecurso) {
            iconoRecurso.dataset.recurso = herramienta.recurso || "";
          }

          tbody.appendChild(fila);
        });
      }

      function buscarHerramientaPorId(id) {
        const conjuntos = [
          herramientasCache.activos,
          herramientasCache.inactivos,
          herramientasCache.sin_estado,
        ];
        for (const lista of conjuntos) {
          if (!Array.isArray(lista)) {
            continue;
          }
          const encontrada = lista.find((item) => Number(item.id) === id);
          if (encontrada) {
            return encontrada;
          }
        }
        return null;
      }

      function escaparHtml(texto) {
        const div = document.createElement("div");
        div.textContent = texto;
        return div.innerHTML;
      }

      async function guardarHerramienta() {
        const nombre = (ui.nombreHerramienta?.value || "").trim();
        const descripcion = (ui.descripcionHerramienta?.value || "").trim();
        const tipoServicio = ui.tipoServicioHerramienta
          ? ui.tipoServicioHerramienta.value
          : "";
        const categoria = ui.categoriaHerramienta
          ? ui.categoriaHerramienta.value
          : "";
        const recurso = (ui.recursoHerramienta?.value || "").trim();

        const institucionId = ui.institucionTag
          ? Number(ui.institucionTag.dataset.institucionId || 0)
          : 0;

        const esEdicion = Boolean(herramientaEditandoId);

        if (!nombre || !tipoServicio || !categoria) {
          M.toast({ html: "Complete los campos obligatorios." });
          return;
        }

        if (!institucionId) {
          M.toast({
            html: "No se encontró la institución asociada al usuario.",
          });
          return;
        }

        const payload = {
          nombre: nombre,
          id_tipo_servicio: Number(tipoServicio),
          id_categoria: Number(categoria),
          descripcion: descripcion,
          recurso: recurso,
        };

        if (!esEdicion) {
          payload.id_institucion = institucionId;
        }

        try {
          const url = esEdicion
            ? `/herramientas_digitales/${herramientaEditandoId}`
            : "/herramientas_digitales/guardar";
          const method = esEdicion ? "PUT" : "POST";
          const resp = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const resultado = await resp.json();

          if (!resp.ok) {
            throw new Error(
              resultado.message ||
                (esEdicion
                  ? "No se pudo actualizar la herramienta"
                  : "No se pudo registrar la herramienta")
            );
          }

          const mensajeExito = esEdicion
            ? "Herramienta actualizada correctamente"
            : "Herramienta registrada correctamente";
          M.toast({ html: mensajeExito });
          const modal = obtenerInstanciaModal(ui.modalHerramienta);
          modal?.close();
          if (ui.formHerramienta) {
            ui.formHerramienta.reset();
          }
          inicializarSelects();
          M.updateTextFields();
          if (ui.modalTituloHerramienta) {
            ui.modalTituloHerramienta.textContent = "NUEVA HERRAMIENTA DIGITAL";
          }
          if (ui.descripcionHerramienta) {
            ui.descripcionHerramienta.value = "";
            M.textareaAutoResize(ui.descripcionHerramienta);
          }
          herramientaEditandoId = null;
          cargarHerramientas();
        } catch (err) {
          M.toast({ html: err.message || "Error al guardar la herramienta" });
        }
      }

      function manejarAccionesTabla(event) {
        const target = event.target;
        if (target.classList.contains("accion-enlace")) {
          const recurso = target.dataset.recurso;
          if (!recurso) {
            M.toast({ html: "La herramienta no tiene un recurso disponible." });
            return;
          }
          window.open(recurso, "_blank", "noopener");
          return;
        }

        if (target.classList.contains("accion-editar")) {
          const id = Number(target.dataset.id);
          const herramienta = buscarHerramientaPorId(id);
          if (!herramienta) {
            M.toast({
              html: "No se encontró la información de la herramienta",
            });
            return;
          }
          abrirModalEdicion(herramienta);
        } else if (target.classList.contains("accion-eliminar")) {
          const id = Number(target.dataset.id);
          solicitarConfirmacionEliminacion(id);
        }
      }

      function abrirModalEdicion(herramienta) {
        herramientaEditandoId = herramienta.id;
        if (ui.modalTituloHerramienta) {
          ui.modalTituloHerramienta.textContent = "EDITAR HERRAMIENTA DIGITAL";
        }

        if (ui.nombreHerramienta) {
          ui.nombreHerramienta.value = herramienta.nombre || "";
        }
        if (ui.descripcionHerramienta) {
          ui.descripcionHerramienta.value = herramienta.descripcion || "";
          M.textareaAutoResize(ui.descripcionHerramienta);
        }
        establecerValorSelect(
          ui.tipoServicioHerramienta,
          herramienta.id_tipo_servicio
        );
        establecerValorSelect(
          ui.categoriaHerramienta,
          herramienta.id_categoria
        );
        if (ui.recursoHerramienta) {
          ui.recursoHerramienta.value = herramienta.recurso || "";
        }

        inicializarSelects();
        M.updateTextFields();

        const modal = obtenerInstanciaModal(ui.modalHerramienta);
        modal?.open();
      }

      function establecerValorSelect(select, valor) {
        if (!select) {
          return;
        }
        select.value = valor == null ? "" : String(valor);
        const instanciaExistente = M.FormSelect.getInstance(select);
        if (instanciaExistente) {
          instanciaExistente.destroy();
        }
        M.FormSelect.init(select);
      }

      function solicitarConfirmacionEliminacion(id) {
        herramientaEliminandoId = id;
        const modal = obtenerInstanciaModal(ui.modalConfirmacion);
        modal?.open();
      }

      async function confirmarEliminacion() {
        if (!herramientaEliminandoId) {
          cerrarModalConfirmacion();
          return;
        }
        await eliminarHerramienta(herramientaEliminandoId);
      }

      function cerrarModalConfirmacion() {
        const modal = obtenerInstanciaModal(ui.modalConfirmacion);
        modal?.close();
        herramientaEliminandoId = null;
      }

      function obtenerInstanciaModal(elemento) {
        return elemento ? M.Modal.getInstance(elemento) : null;
      }

      async function eliminarHerramienta(id) {
        try {
          const resp = await fetch(`/herramientas_digitales/${id}`, {
            method: "DELETE",
          });
          const resultado = await resp.json();

          if (!resp.ok) {
            throw new Error(
              resultado.message || "No se pudo eliminar la herramienta"
            );
          }

          M.toast({ html: "Herramienta eliminada correctamente" });
          cerrarModalConfirmacion();
          cargarHerramientas();
        } catch (err) {
          M.toast({ html: err.message || "Error al eliminar la herramienta" });
        }
      }
    </script>
  </body>
</html>
