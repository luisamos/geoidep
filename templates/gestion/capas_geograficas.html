<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='images/favicon-1760a09d.ico' ) }}"
    />
    <title>GEOIDEP | Capas geogr谩ficas</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .icono-tabla {
        width: 32px;
        height: 32px;
        cursor: pointer;
      }

      .tabla-capas {
        background-color: #fff;
        width: 100%;
      }

      .tabla-capas th,
      .tabla-capas td {
        vertical-align: middle;
        word-break: break-word;
      }

      .tabla-capas .col-indice {
        width: 50px;
      }

      .tabla-capas .col-nombre {
        max-width: 220px;
      }

      .tabla-capas .col-categoria,
      .tabla-capas .col-institucion {
        width: 160px;
      }

      .tabla-capas .col-servicios {
        max-width: 260px;
      }

      .tabla-capas .col-opciones {
        width: 140px;
      }

      .estado-switch {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .tabla-servicios {
        margin-top: 24px;
      }

      .tabla-servicios table {
        width: 100%;
      }

      .tabla-servicios th,
      .tabla-servicios td {
        vertical-align: middle;
      }

      .tabla-servicios select.browser-default,
      .tabla-servicios input[type="text"] {
        margin: 0;
      }

      .acciones-servicio {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .btn-icono {
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 4px;
      }

      .btn-icono:focus {
        outline: none;
      }

      .estado-indicador {
        font-size: 1.4rem;
      }
    </style>
  </head>

  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <div class="row">
          <div class="col s12">
            <h3>Capas geogr谩ficas</h3>
            <p class="flow-text">
              Administra la informaci贸n de las capas y servicios geoespaciales.
            </p>
          </div>
          <div class="input-field col s12 m6 l4">
            <input
              id="txtBuscarNombre"
              type="text"
              class="validate"
              placeholder="Buscar por nombre"
            />
            <label for="txtBuscarNombre">Nombre de la capa</label>
          </div>
          <div class="input-field col s12 m4 l3">
            <select id="filtroTipoServicio">
              <option value="" selected>Todos los servicios</option>
              {% for tipo in tipos_serv | sort(attribute='id') %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
            <label>Tipo de servicio</label>
          </div>
          <div class="col s6 m2 l2">
            <button id="btnBuscar" class="btn btn-small blue" type="button">
              <i class="material-icons left">search</i> Buscar
            </button>
          </div>
          <div class="col s6 m2 l3 right-align">
            <button
              id="btnAgregar"
              class="btn waves-light btn-small green"
              data-target="modalCapa"
              type="button"
            >
              <i class="material-icons left">add</i>Nueva capa
            </button>
          </div>
        </div>

        <div class="row" style="max-height: 600px; overflow-y: auto">
          <div class="col s12">
            <table class="highlight tabla-capas" id="tablaCapas">
              <thead>
                <tr>
                  <th class="col-indice" style="padding-left: 20px">N掳</th>
                  <th class="col-nombre">Nombre</th>
                  <th class="col-categoria">Categor铆a</th>
                  <th class="col-institucion">Sigla instituci贸n</th>
                  <th class="col-servicios">Servicios</th>
                  <th class="col-opciones">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      id="institucionTag"
      data-institucion-id="{{ institucion_usuario.id if institucion_usuario else '' }}"
      data-institucion-nombre="{{ institucion_usuario.nombre if institucion_usuario else '' }}"
      data-permite-editar="{{ 'true' if puede_editar_institucion else 'false' }}"
      hidden
    ></div>

    <div id="modalCapa" class="modal">
      <div class="modal-content">
        <div
          class="row center"
          style="border-bottom: 3px solid rgba(1, 11, 100, 0.14)"
        >
          <h5 id="modalTituloCapa">CAPA GEOGRFICA</h5>
          <img
            id="imgClose_modal_layer"
            alt="Cerrar ventana"
            src="{{ url_for('static', filename='images/close.png') }}"
            style="position: absolute; right: 10px; top: 10px"
          />
        </div>
        <form id="formCapa">
          <input type="hidden" id="capaId" />
          <div class="input-field">
            <input id="nombre_capa" type="text" maxlength="200" required />
            <label for="nombre_capa">Nombre</label>
          </div>

          <div class="input-field">
            <textarea
              id="descripcion_capa"
              class="materialize-textarea"
              maxlength="800"
            ></textarea>
            <label for="descripcion_capa">Descripci贸n (opcional)</label>
          </div>

          <div class="input-field">
            <select id="tipo_capa_modal" required>
              <option value="" disabled selected>Seleccione tipo</option>
              <option value="1">P煤blico</option>
              <option value="2">Privado</option>
            </select>
            <label>Tipo de capa</label>
          </div>

          <div class="estado-switch">
            <span>Publicar en GeoPer煤</span>
            <div class="switch">
              <label>
                No
                <input type="checkbox" id="publicar_geoperu" />
                <span class="lever"></span>
                S铆
              </label>
            </div>
          </div>

          <div class="input-field">
            <select id="categoria_capa" required>
              <option value="" disabled selected>Seleccione categor铆a</option>
              {% for cat in categorias %}
              <option value="{{ cat.id }}">{{ cat.nombre }}</option>
              {% endfor %}
            </select>
            <label>Categor铆a</label>
          </div>

          <div class="input-field">
            <select id="institucion_capa" required>
              <option value="" disabled selected>Seleccione instituci贸n</option>
              {% for inst in instituciones %}
              <option value="{{ inst.id }}">{{ inst.nombre }}</option>
              {% endfor %}
            </select>
            <label>Instituci贸n</label>
          </div>

          <div class="tabla-servicios">
            <h6>Servicios Asociados</h6>
            <div class="responsive-table">
              <table class="highlight" id="tablaServicios">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Direcci贸n</th>
                    <th>Capa</th>
                    <th class="center-align">Estado</th>
                    <th class="center-align">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="right-align" style="margin-top: 12px">
              <button class="btn orange" id="btnAddServicio" type="button">
                Agregar Servicio
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="modal-close btn grey" type="button">Cancelar</button>
        <button class="btn blue" id="btnGuardar" type="button">Guardar</button>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
    <script>
      const iconoEditar = "{{ url_for('static', filename='images/edit.png') }}";
      const iconoEliminar =
        "{{ url_for('static', filename='images/delete.png') }}";
      const tiposServicio = {{ tipos_serv | tojson | safe }};

      const tablaCapas = document.querySelector("#tablaCapas tbody");
      let capas = [];
      let modalInstance = null;
      const tablaServiciosBody = document.querySelector(
        "#tablaServicios tbody"
      );

      function inicializarComponentesBase() {
        const selects = document.querySelectorAll(
          "select:not(.browser-default)"
        );
        M.FormSelect.init(selects);
        if (!modalInstance) {
          const modalElement = document.getElementById("modalCapa");
          if (modalElement) {
            modalInstance = M.Modal.init(modalElement, { dismissible: false });
          }
        }
      }

      function refrescarCamposFormulario() {
        const formSelects = document.querySelectorAll(
          "#formCapa select:not(.browser-default)"
        );
        M.FormSelect.init(formSelects);
        M.updateTextFields();
      }

      function limpiarFormulario() {
        const form = document.getElementById("formCapa");
        form.reset();
        document.getElementById("capaId").value = "";
        limpiarTablaServicios();
        agregarFilaServicio();
        setTimeout(() => {
          refrescarCamposFormulario();
        }, 0);
      }

      function limpiarTablaServicios() {
        if (tablaServiciosBody) {
          tablaServiciosBody.innerHTML = "";
        }
      }

      function esServicioOgc(tipoId) {
        const tipo = tiposServicio.find(
          (item) => String(item.id) === String(tipoId)
        );
        if (!tipo) return false;
        return Number(tipo.id_padre) === 2;
      }

      function crearSelectTiposServicio(valorActual = "") {
        const select = document.createElement("select");
        select.className = "browser-default tipo-servicio";
        const opcionDefault = document.createElement("option");
        opcionDefault.value = "";
        opcionDefault.textContent = "Seleccione";
        select.appendChild(opcionDefault);

        tiposServicio
          .slice()
          .sort((a, b) => Number(a.id) - Number(b.id))
          .forEach((tipo) => {
            const opcion = document.createElement("option");
            opcion.value = tipo.id;
            opcion.textContent = tipo.nombre;
            if (String(tipo.id) === String(valorActual)) {
              opcion.selected = true;
            }
            select.appendChild(opcion);
          });
        return select;
      }

      function crearInputDireccion(valor = "") {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "direccion-servicio";
        input.placeholder = "URL del servicio";
        input.value = valor || "";
        input.required = true;
        return input;
      }

      function crearCampoCapaComoInput(valor = "") {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "nombre-capa-input";
        input.placeholder = "Nombre de capa";
        input.value = valor || "";
        return input;
      }

      function crearCampoCapaComoSelect(opciones = [], valorActual = "") {
        const select = document.createElement("select");
        select.className = "browser-default nombre-capa-select";
        const opcionDefault = document.createElement("option");
        opcionDefault.value = "";
        opcionDefault.textContent = "Seleccione capa";
        select.appendChild(opcionDefault);
        opciones.forEach((opcion) => {
          const optionElement = document.createElement("option");
          optionElement.value = opcion.value;
          optionElement.textContent = opcion.label || opcion.value;
          if (String(opcion.value) === String(valorActual)) {
            optionElement.selected = true;
          }
          select.appendChild(optionElement);
        });
        return select;
      }

      function setEstadoFilaServicio(fila, estado) {
        const indicador = fila.querySelector(".estado-indicador");
        if (indicador) {
          indicador.textContent = estado ? "" : "";
          indicador.dataset.valor = estado ? "true" : "false";
        }
      }

      function agregarFilaServicio(servicio = {}) {
        if (!tablaServiciosBody) return;

        const fila = document.createElement("tr");
        if (servicio.id) {
          fila.dataset.servicioId = servicio.id;
        }
        fila.dataset.visible = servicio.visible === false ? "false" : "true";
        fila.dataset.tipo = servicio.id_tipo_servicio || "";

        const celdaTipo = document.createElement("td");
        const selectTipo = crearSelectTiposServicio(
          servicio.id_tipo_servicio || ""
        );
        celdaTipo.appendChild(selectTipo);

        const celdaDireccion = document.createElement("td");
        const inputDireccion = crearInputDireccion(servicio.direccion_web || "");
        celdaDireccion.appendChild(inputDireccion);

        const celdaCapa = document.createElement("td");
        celdaCapa.className = "celda-capa";
        if (servicio.opciones_capas && servicio.opciones_capas.length) {
          const selectCapas = crearCampoCapaComoSelect(
            servicio.opciones_capas,
            servicio.nombre_capa || ""
          );
          celdaCapa.appendChild(selectCapas);
          fila.dataset.opcionesCapas = JSON.stringify(servicio.opciones_capas);
        } else {
          celdaCapa.appendChild(
            crearCampoCapaComoInput(servicio.nombre_capa || "")
          );
        }

        const celdaEstado = document.createElement("td");
        celdaEstado.className = "center-align";
        const spanEstado = document.createElement("span");
        spanEstado.className = "estado-indicador";
        const esOgc = esServicioOgc(servicio.id_tipo_servicio || "");
        const estadoInicial = esOgc
          ? Boolean(servicio.nombre_capa && servicio.nombre_capa.trim())
          : true;
        spanEstado.textContent = estadoInicial ? "" : "";
        spanEstado.dataset.valor = estadoInicial ? "true" : "false";
        celdaEstado.appendChild(spanEstado);

        const celdaAcciones = document.createElement("td");
        celdaAcciones.className = "center-align";
        const contenedorAcciones = document.createElement("div");
        contenedorAcciones.className = "acciones-servicio";

        const botonConectar = document.createElement("button");
        botonConectar.type = "button";
        botonConectar.className = "btn-icono btn-conectar";
        botonConectar.title = "Conectarse";
        botonConectar.innerHTML = '<i class="material-icons">sync</i>';

        const botonEliminar = document.createElement("button");
        botonEliminar.type = "button";
        botonEliminar.className = "btn-icono btn-eliminar-servicio";
        botonEliminar.title = "Eliminar";
        botonEliminar.innerHTML = '<i class="material-icons red-text">delete</i>';

        contenedorAcciones.appendChild(botonConectar);
        contenedorAcciones.appendChild(botonEliminar);
        celdaAcciones.appendChild(contenedorAcciones);

        fila.appendChild(celdaTipo);
        fila.appendChild(celdaDireccion);
        fila.appendChild(celdaCapa);
        fila.appendChild(celdaEstado);
        fila.appendChild(celdaAcciones);

        tablaServiciosBody.appendChild(fila);
      }

      function obtenerOpcionesDesdeFila(fila) {
        try {
          return fila.dataset.opcionesCapas
            ? JSON.parse(fila.dataset.opcionesCapas)
            : [];
        } catch (error) {
          return [];
        }
      }

      function actualizarCampoCapaParaFila(fila, esOgc) {
        const celdaCapa = fila.querySelector(".celda-capa");
        if (!celdaCapa) return;
        const valorActual = obtenerValorNombreCapa(fila);
        celdaCapa.innerHTML = "";
        if (esOgc) {
          const opciones = obtenerOpcionesDesdeFila(fila);
          if (opciones.length) {
            celdaCapa.appendChild(
              crearCampoCapaComoSelect(opciones, valorActual || "")
            );
          } else {
            celdaCapa.appendChild(crearCampoCapaComoInput(valorActual || ""));
          }
        } else {
          celdaCapa.appendChild(crearCampoCapaComoInput(valorActual || ""));
          fila.dataset.opcionesCapas = "";
          setEstadoFilaServicio(fila, true);
        }
      }

      function obtenerValorNombreCapa(fila) {
        const select = fila.querySelector(".nombre-capa-select");
        if (select) {
          return select.value;
        }
        const input = fila.querySelector(".nombre-capa-input");
        return input ? input.value : "";
      }

      async function conectarServicioOgc(fila) {
        const selectTipo = fila.querySelector(".tipo-servicio");
               const inputDireccion = fila.querySelector(".direccion-servicio");
        if (!selectTipo || !inputDireccion) return;

        const tipoId = selectTipo.value;
        const direccion = inputDireccion.value.trim();

        if (!tipoId) {
          M.toast({ html: "Seleccione el tipo de servicio." });
          return;
        }

        if (!direccion) {
          M.toast({ html: "Ingrese la direcci贸n del servicio." });
          return;
        }

        if (!esServicioOgc(tipoId)) {
          M.toast({ html: "El servicio seleccionado no requiere conexi贸n." });
          actualizarCampoCapaParaFila(fila, false);
          return;
        }

        setEstadoFilaServicio(fila, false);
        try {
          const respuesta = await fetch(
            "/capas_geograficas/servicios/capabilities",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                tipo_servicio_id: tipoId,
                url: direccion,
              }),
            }
          );

          const json = await respuesta.json();
          if (!respuesta.ok || json.status !== "success") {
            throw new Error(json.message || "No se pudo obtener las capas.");
          }

          const capasDisponibles = Array.isArray(json.capas)
            ? json.capas
            : [];
          if (!capasDisponibles.length) {
            throw new Error("El servicio no devolvi贸 capas disponibles.");
          }

          fila.dataset.opcionesCapas = JSON.stringify(capasDisponibles);
          const celdaCapa = fila.querySelector(".celda-capa");
          if (celdaCapa) {
            celdaCapa.innerHTML = "";
            celdaCapa.appendChild(
              crearCampoCapaComoSelect(
                capasDisponibles,
                obtenerValorNombreCapa(fila) || ""
              )
            );
          }
          setEstadoFilaServicio(fila, true);
          M.toast({ html: "Capas obtenidas correctamente." });
        } catch (error) {
          console.error(error);
          fila.dataset.opcionesCapas = "";
          actualizarCampoCapaParaFila(fila, true);
          setEstadoFilaServicio(fila, false);
          M.toast({ html: error.message || "No se pudo conectar al servicio." });
        }
      }

      function obtenerServiciosDeTabla() {
        if (!tablaServiciosBody) return [];
        const filas = Array.from(tablaServiciosBody.querySelectorAll("tr"));
        return filas
          .map((fila) => {
            const selectTipo = fila.querySelector(".tipo-servicio");
            const inputDireccion = fila.querySelector(".direccion-servicio");
            const nombreCapa = obtenerValorNombreCapa(fila);
            if (!selectTipo || !inputDireccion) {
              return null;
            }
            const tipoId = selectTipo.value;
            const direccion = inputDireccion.value.trim();
            const visible = fila.dataset.visible !== "false";
            const idServicio = fila.dataset.servicioId
              ? Number(fila.dataset.servicioId)
              : null;
            const camposVacios =
              !tipoId && !direccion && !(nombreCapa && nombreCapa.trim());
            if (camposVacios && !idServicio) {
              return null;
            }

            return {
              id: idServicio,
              tipo_servicio_id: tipoId ? Number(tipoId) : null,
              direccion: direccion,
              nombre_capa: nombreCapa ? nombreCapa.trim() : "",
              visible,
            };
          })
          .filter((item) => item !== null);
      }

      function validarServicios(servicios) {
        for (const servicio of servicios) {
          if (!servicio.tipo_servicio_id) {
            M.toast({ html: "Cada servicio debe tener un tipo seleccionado." });
            return false;
          }
          if (!servicio.direccion) {
            M.toast({ html: "Cada servicio debe tener una direcci贸n." });
            return false;
          }
          if (
            esServicioOgc(servicio.tipo_servicio_id) &&
            !servicio.nombre_capa
          ) {
            M.toast({
              html: "Los servicios OGC deben tener una capa seleccionada.",
            });
            return false;
          }
        }
        return true;
      }

      async function cargarServiciosDeCapa(capaId) {
        limpiarTablaServicios();
        try {
          const respuesta = await fetch(`/capas_geograficas/detalle/${capaId}`);
          if (!respuesta.ok) {
            throw new Error("No se pudo obtener el detalle de la capa.");
          }
          const json = await respuesta.json();
          const servicios = Array.isArray(json.servicios) ? json.servicios : [];
          if (!servicios.length) {
            agregarFilaServicio();
          } else {
            servicios.forEach((servicio) => {
              agregarFilaServicio({
                id: servicio.id,
                id_tipo_servicio: servicio.id_tipo_servicio,
                direccion_web: servicio.direccion_web,
                nombre_capa: servicio.nombre_capa,
                visible: servicio.visible,
              });
            });
          }
        } catch (error) {
          console.error(error);
          M.toast({ html: error.message || "Error al cargar servicios." });
          agregarFilaServicio();
        }
      }

      function cerrarModal() {
        if (modalInstance) {
          modalInstance.close();
        }
      }

      function abrirModalParaNueva() {
        limpiarFormulario();
        document.getElementById("modalTituloCapa").textContent =
          "NUEVA CAPA GEOGRFICA";
        if (!modalInstance) {
          inicializarComponentesBase();
        }
        if (modalInstance) {
          modalInstance.open();
        }
      }

      async function abrirModalParaEditar(capa) {
        limpiarFormulario();
        document.getElementById("modalTituloCapa").textContent =
          "EDITAR CAPA GEOGRFICA";
        document.getElementById("capaId").value = capa.id;
        document.getElementById("nombre_capa").value = capa.nombre || "";
        document.getElementById("descripcion_capa").value =
          capa.descripcion || "";
        document.getElementById("tipo_capa_modal").value = String(
          capa.tipo_capa || ""
        );
        document.getElementById("publicar_geoperu").checked = !!capa.en_geoperu;
        document.getElementById("categoria_capa").value =
          capa.id_categoria || "";
        document.getElementById("institucion_capa").value =
          capa.id_institucion || "";
        await cargarServiciosDeCapa(capa.id);
        setTimeout(() => {
          refrescarCamposFormulario();
        }, 0);
        if (!modalInstance) {
          inicializarComponentesBase();
        }
        if (modalInstance) {
          modalInstance.open();
        }
      }

      function renderTabla(data) {
        tablaCapas.innerHTML = "";
        if (!data.length) {
          const fila = document.createElement("tr");
          const celda = document.createElement("td");
          celda.colSpan = 6;
          celda.textContent = "No hay capas registradas.";
          fila.appendChild(celda);
          tablaCapas.appendChild(fila);
          return;
        }

        data.forEach((capa, index) => {
          const fila = document.createElement("tr");
          const nombre = escaparHtml(capa.nombre || "");
          const categoria = escaparHtml(capa.categoria || "");
          const institucion = escaparHtml(capa.institucion_sigla || "");
          const servicios = escaparHtml(capa.servicios || "");
          fila.innerHTML = `
            <td style="padding-left:20px;">${index + 1}</td>
            <td>${nombre}</td>
            <td>${categoria}</td>
            <td>${institucion}</td>
            <td>${servicios}</td>
            <td class="col-opciones">
              <img
                src="${iconoEditar}"
                class="icono-tabla accion-actualizar"
                data-action="actualizar"
                data-id="${capa.id}"
                alt="Actualizar"
                title="Actualizar"
              />
              <img
                src="${iconoEliminar}"
                class="icono-tabla accion-eliminar"
                data-action="eliminar"
                data-id="${capa.id}"
                alt="Eliminar"
                title="Eliminar"
              />
            </td>
          `;
          tablaCapas.appendChild(fila);
        });
      }

      async function cargarCapas() {
        try {
          const respuesta = await fetch("/capas_geograficas/listar");
          if (!respuesta.ok) {
            throw new Error("No se pudo obtener la lista de capas.");
          }
          capas = await respuesta.json();
          aplicarFiltros();
        } catch (error) {
          console.error(error);
          M.toast({ html: error.message || "Error al cargar las capas." });
        }
      }

      function aplicarFiltros() {
        const filtroNombre = (
          document.getElementById("txtBuscarNombre").value || ""
        )
          .toLowerCase()
          .trim();
        const filtroTipoServicio =
          document.getElementById("filtroTipoServicio").value;

        const filtradas = capas.filter((capa) => {
          const coincideNombre = capa.nombre
            ? capa.nombre.toLowerCase().includes(filtroNombre)
            : false;
          const coincideServicio = filtroTipoServicio
            ? Array.isArray(capa.servicio_ids) &&
              capa.servicio_ids.some(
                (idServicio) =>
                  String(idServicio) === String(filtroTipoServicio)
              )
            : true;
          return coincideNombre && coincideServicio;
        });

        renderTabla(filtradas);
      }

      function escaparHtml(texto) {
        const div = document.createElement("div");
        div.textContent = texto;
        return div.innerHTML;
      }

      async function guardarCapa() {
        const id = document.getElementById("capaId").value || null;
        const nombre = document.getElementById("nombre_capa").value.trim();
        const descripcion = document
          .getElementById("descripcion_capa")
          .value.trim();
        const tipoCapa = document.getElementById("tipo_capa_modal").value;
        const publicar = document.getElementById("publicar_geoperu").checked;
        const categoriaId = document.getElementById("categoria_capa").value;
        const institucionId = document.getElementById("institucion_capa").value;

        if (!nombre || !tipoCapa || !categoriaId || !institucionId) {
          M.toast({ html: "Complete los campos obligatorios." });
          return;
        }

        const servicios = obtenerServiciosDeTabla();
        if (!validarServicios(servicios)) {
          return;
        }

        const payload = {
          id,
          nombre,
          descripcion,
          tipo_capa: tipoCapa,
          publicar_geoperu: publicar,
          categoria_id: categoriaId,
          institucion_id: institucionId,
          servicios,
        };

        try {
          const respuesta = await fetch("/capas_geograficas/guardar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const json = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(json.message || "No se pudo guardar la capa.");
          }
          M.toast({ html: "Capa guardada correctamente." });
          cerrarModal();
          await cargarCapas();
        } catch (error) {
          console.error(error);
          M.toast({ html: error.message || "Error al guardar la capa." });
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        inicializarComponentesBase();
        cargarCapas();

        document.getElementById("btnAgregar").addEventListener("click", () => {
          abrirModalParaNueva();
        });

        document
          .getElementById("imgClose_modal_layer")
          .addEventListener("click", () => {
            cerrarModal();
          });

        document
          .getElementById("btnGuardar")
          .addEventListener("click", guardarCapa);

        const botonAgregarServicio = document.getElementById("btnAddServicio");
        if (botonAgregarServicio) {
          botonAgregarServicio.addEventListener("click", () => {
            agregarFilaServicio();
          });
        }

        document
          .getElementById("btnBuscar")
          .addEventListener("click", aplicarFiltros);
        document
          .getElementById("txtBuscarNombre")
          .addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
              aplicarFiltros();
            }
          });
        document
          .getElementById("filtroTipoServicio")
          .addEventListener("change", aplicarFiltros);

        tablaCapas.addEventListener("click", async (event) => {
          const accion = event.target.closest("img[data-action]");
          if (!accion) return;
          const id = accion.getAttribute("data-id");
          const tipo = accion.getAttribute("data-action");
          const capa = capas.find((item) => String(item.id) === String(id));
          if (!capa) return;
          if (tipo === "actualizar") {
            await abrirModalParaEditar(capa);
          } else if (tipo === "eliminar") {
            M.toast({ html: "La eliminaci贸n se habilitar谩 pr贸ximamente." });
          }
        });

        if (tablaServiciosBody) {
          tablaServiciosBody.addEventListener("change", (event) => {
            const fila = event.target.closest("tr");
            if (!fila) return;
            if (event.target.classList.contains("tipo-servicio")) {
              const tipoId = event.target.value;
              const esOgc = esServicioOgc(tipoId);
              actualizarCampoCapaParaFila(fila, esOgc);
              if (!esOgc) {
                setEstadoFilaServicio(fila, true);
              } else {
                setEstadoFilaServicio(fila, false);
              }
            }
          });

          tablaServiciosBody.addEventListener("click", (event) => {
            const fila = event.target.closest("tr");
            if (!fila) return;

            if (event.target.closest(".btn-conectar")) {
              conectarServicioOgc(fila);
              return;
            }

            if (event.target.closest(".btn-eliminar-servicio")) {
              fila.remove();
              if (!tablaServiciosBody.querySelector("tr")) {
                agregarFilaServicio();
              }
            }
          });
        }
      });
    </script>
  </body>
</html>
