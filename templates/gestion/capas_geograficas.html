<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='images/favicon-1760a09d.ico' ) }}"
    />
    <title>GEOIDEP | Capas geográficas</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .icono-tabla {
        width: 32px;
        height: 32px;
        cursor: pointer;
      }

      .tabla-capas {
        background-color: #fff;
        width: 100%;
      }

      .tabla-capas th,
      .tabla-capas td {
        vertical-align: middle;
        word-break: break-word;
      }

      .tabla-capas .col-indice {
        width: 50px;
      }

      .tabla-capas .col-nombre {
        max-width: 220px;
      }

      .tabla-capas .col-categoria,
      .tabla-capas .col-institucion {
        width: 160px;
      }

      .tabla-capas .col-servicios {
        max-width: 260px;
      }

      .tabla-capas .col-opciones {
        width: 140px;
      }

      .estado-switch {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .tabla-servicios {
        margin-top: 24px;
      }

      .tabla-servicios table {
        width: 100%;
      }

      .tabla-servicios th,
      .tabla-servicios td {
        vertical-align: middle;
      }

      .tabla-servicios select.browser-default,
      .tabla-servicios input[type="text"] {
        margin: 0;
      }

      .acciones-servicio {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .btn-icono {
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 4px;
      }

      .btn-icono:focus {
        outline: none;
      }

      .estado-indicador {
        font-size: 1.4rem;
      }

      .estado-indicador--oculto {
        visibility: hidden;
      }

      .estado-filtros {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .estado-filtros-row {
        margin-bottom: 0;
      }

      .estado-filtros-acciones {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 8px 0;
      }

      @media (max-width: 600px) {
        .estado-filtros-acciones {
          justify-content: flex-start;
        }
      }

      .servicios-listado {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .servicio-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 10px;
        border-radius: 14px;
        border: 2px solid transparent;
        font-size: 0.85rem;
        line-height: 1.4;
        background-color: #fafafa;
      }

      .servicio-badge--activo {
        border-color: #2e7d32;
        color: #2e7d32;
      }

      .servicio-badge--inactivo {
        border-color: #c62828;
        color: #c62828;
      }

      .servicio-badge--sin-estado {
        border-color: #9e9e9e;
        color: #616161;
      }

      .select-search-wrapper {
        padding: 8px 16px;
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 2;
      }

      .select-search-wrapper input {
        margin: 0;
      }

      .select-dropdown.dropdown-content.with-search {
        max-height: 260px !important;
        overflow-y: auto !important;
      }
    </style>
  </head>

  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <div class="row">
          <div class="col s12">
            <h3>Capas geográficas</h3>
            <p class="flow-text">
              Administra la información de las capas y servicios de la
              Infraestructura de Datos Espaciales del Perú.
            </p>
          </div>
          <div class="input-field col s12 m6 l4">
            <input
              id="txtBuscarNombre"
              type="text"
              class="validate"
              placeholder="Buscar por nombre"
            />
            <label for="txtBuscarNombre">Nombre de la capa</label>
          </div>
          <div class="input-field col s12 m4 l3">
            <select id="filtroTipoServicio">
              <option value="" selected>Todos los servicios</option>
              {% for tipo in tipos_serv | sort(attribute='id') %}
              <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
            <label>Tipo de servicio</label>
          </div>
          <div class="col s6 m2 l2">
            <button id="btnBuscar" class="btn btn-small blue" type="button">
              <i class="material-icons left">search</i> Buscar
            </button>
          </div>
        </div>

        <div class="row estado-filtros-row">
          <div class="col s12 m6 l6">
            <div class="estado-filtros">
              <div class="switch">
                <label>
                  Inactivo
                  <input type="checkbox" id="switchEstados" checked />
                  <span class="lever"></span>
                  Activo
                </label>
              </div>
            </div>
          </div>
          <div class="col s12 m6 l6 estado-filtros-acciones right-align">
            <button
              id="btnAgregar"
              class="btn waves-light btn-small green"
              data-target="modalCapa"
              type="button"
            >
              <i class="material-icons left">add</i>Nueva capa
            </button>
          </div>
        </div>

        <div class="row" style="max-height: 600px; overflow-y: auto">
          <div class="col s12">
            <table class="highlight tabla-capas" id="tablaCapas">
              <thead>
                <tr>
                  <th class="col-indice" style="padding-left: 20px">N°</th>
                  <th class="col-nombre">Nombre</th>
                  <th class="col-categoria">Categoría</th>
                  <th class="col-institucion">Institución</th>
                  <th class="col-servicios">Servicios</th>
                  <th class="col-opciones">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      id="institucionTag"
      data-institucion-id="{{ institucion_usuario.id if institucion_usuario else '' }}"
      data-institucion-nombre="{{ institucion_usuario.nombre if institucion_usuario else '' }}"
      data-permite-editar="{{ 'true' if puede_editar_institucion else 'false' }}"
      hidden
    ></div>

    <div id="modalCapa" class="modal">
      <div class="modal-content">
        <div
          class="row center"
          style="border-bottom: 3px solid rgba(1, 11, 100, 0.14)"
        >
          <h5 id="modalTituloCapa">CAPA GEOGRÁFICA</h5>
          <img
            id="imgClose_modal_layer"
            alt="Cerrar ventana"
            src="{{ url_for('static', filename='images/close.png') }}"
            style="position: absolute; right: 10px; top: 10px"
          />
        </div>
        <form id="formCapa">
          <input type="hidden" id="capaId" />
          <div class="input-field">
            <input id="nombre_capa" type="text" maxlength="200" required />
            <label for="nombre_capa">Nombre</label>
          </div>

          <div class="input-field">
            <textarea
              id="descripcion_capa"
              class="materialize-textarea"
              maxlength="800"
            ></textarea>
            <label for="descripcion_capa">Descripción (opcional)</label>
          </div>

          <div class="input-field">
            <select id="tipo_capa_modal" required>
              <option value="" disabled selected>Seleccione tipo</option>
              <option value="1">Público</option>
              <option value="2">Privado</option>
            </select>
            <label>Tipo de capa</label>
          </div>

          <div class="estado-switch">
            <span>Publicar en GeoPerú</span>
            <div class="switch">
              <label>
                No
                <input type="checkbox" id="publicar_geoperu" />
                <span class="lever"></span>
                Sí
              </label>
            </div>
          </div>

          <div class="input-field">
            <select id="categoria_capa" required>
              <option value="" disabled selected>Seleccione categoría</option>
              {% for cat in categorias %}
              <option value="{{ cat.id }}">{{ cat.nombre }}</option>
              {% endfor %}
            </select>
            <label>Categoría</label>
          </div>

          <div class="input-field">
            <select id="institucion_capa" required>
              <option value="" disabled selected>Seleccione institución</option>
              {% for inst in instituciones %}
              <option value="{{ inst.id }}">{{ inst.nombre }}</option>
              {% endfor %}
            </select>
            <label>Institución</label>
          </div>

          <div class="tabla-servicios">
            <h6>Servicios Asociados</h6>
            <div class="responsive-table">
              <table class="highlight" id="tablaServicios">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Dirección</th>
                    <th>Capa</th>
                    <th class="center-align">Estado</th>
                    <th class="center-align">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="right-align" style="margin-top: 12px">
              <button
                class="btn btn-small orange"
                id="btnAddServicio"
                type="button"
              >
                <i class="material-icons small left">add</i>Agregar Servicio
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="modal-close btn grey" type="button">
          <i class="material-icons small left">clear</i>Cancelar
        </button>
        <button class="btn blue" id="btnGuardar" type="button">
          <i class="material-icons small left">save</i>Guardar
        </button>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
    <script>
      const iconoEditar = "{{ url_for('static', filename='images/editar.png') }}";
      const iconoEliminar =
        "{{ url_for('static', filename='images/eliminar.png') }}";
      const tiposServicio = {{ tipos_serv | tojson | safe }};

      function obtenerCookie(nombre) {
        const prefijo = `${nombre}=`;
        const partes = document.cookie ? document.cookie.split("; ") : [];
        for (const parte of partes) {
          if (parte.startsWith(prefijo)) {
            return decodeURIComponent(parte.slice(prefijo.length));
          }
        }
        return null;
      }

      function obtenerTokenCSRF() {
        return obtenerCookie("csrf_access_token");
      }

      function crearOpcionesJson(method, payload) {
        const headers = {};
        const token = obtenerTokenCSRF();
        if (token) {
          headers["X-CSRF-Token"] = token;
        }
        const opciones = { method, headers };
        if (payload !== undefined) {
          headers["Content-Type"] = "application/json";
          opciones.body = JSON.stringify(payload);
        }
        return opciones;
      }

      const ui = {
        tablaCapasBody: null,
        btnBuscar: null,
        txtBuscarNombre: null,
        filtroTipoServicio: null,
        switchEstados: null,
        btnAgregar: null,
        btnGuardar: null,
        modalCapa: null,
        modalTituloCapa: null,
        formCapa: null,
        capaId: null,
        nombreCapa: null,
        descripcionCapa: null,
        tipoCapaModal: null,
        publicarGeoperu: null,
        categoriaCapa: null,
        institucionCapa: null,
        btnAddServicio: null,
        imgCloseModalLayer: null,
        tablaServiciosBody: null,
        institucionTag: null,
      };

      let capas = [];
      let capasCache = { activos: [], inactivos: [], sin_estado: [] };
      let modalInstance = null;

      function inicializarComponentesBase() {
        const selects = document.querySelectorAll(
          "select:not(.browser-default)"
        );
        M.FormSelect.init(selects);
        inicializarBusquedaInstituciones();
        if (!modalInstance) {
          const modalElement = ui.modalCapa;
          if (modalElement) {
            modalInstance = M.Modal.init(modalElement, { dismissible: false });
          }
        }
      }

      function refrescarCamposFormulario() {
        const formSelects = document.querySelectorAll(
          "#formCapa select:not(.browser-default)"
        );
        M.FormSelect.init(formSelects);
        M.updateTextFields();
        inicializarBusquedaInstituciones();
      }

      function inicializarBusquedaInstituciones() {
        const select = ui.institucionCapa;
        if (!select) {
          return;
        }

        const instance = M.FormSelect.getInstance(select);
        if (!instance) {
          return;
        }

        const selectId = select.getAttribute("id");
        if (!selectId) {
          return;
        }

        const dropdownId = `select-options-${selectId}`;
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
          return;
        }

        dropdown.classList.add("with-search");
        dropdown.style.maxHeight = "260px";
        dropdown.style.overflowY = "auto";

        let searchWrapper = dropdown.querySelector(".select-search-wrapper");
        if (!searchWrapper) {
          searchWrapper = document.createElement("li");
          searchWrapper.className = "select-search-wrapper";
          const searchInput = document.createElement("input");
          searchInput.type = "text";
          searchInput.className = "select-search-input";
          searchInput.placeholder = "Buscar institución";
          searchWrapper.appendChild(searchInput);
          dropdown.insertBefore(searchWrapper, dropdown.firstChild);
        }

        const searchInput = searchWrapper.querySelector("input");
        if (!searchInput) {
          return;
        }

        const yaTieneBusqueda = searchInput.dataset.enhanced === "true";

        const obtenerOpciones = () =>
          Array.from(dropdown.querySelectorAll("li")).filter(
            (item) =>
              !item.classList.contains("select-search-wrapper") &&
              !item.classList.contains("optgroup") &&
              !item.classList.contains("divider")
          );

        const dropdownInstance = instance.dropdown;

        const recalcular = () => {
          if (
            dropdownInstance &&
            typeof dropdownInstance.recalculateDimensions === "function"
          ) {
            dropdownInstance.recalculateDimensions();
          }
        };

        const filtrarOpciones = () => {
          const termino = searchInput.value.trim().toLowerCase();
          obtenerOpciones().forEach((item) => {
            if (item.classList.contains("disabled")) {
              return;
            }
            const texto = (item.textContent || "").toLowerCase();
            const coincide = !termino || texto.includes(termino);
            item.style.display = coincide ? "" : "none";
          });
          recalcular();
        };

        if (!yaTieneBusqueda) {
          searchInput.addEventListener("input", filtrarOpciones);
        }

        if (dropdownInstance && !dropdownInstance.__searchEnhanced) {
          const originalOpen = dropdownInstance.options.onOpenEnd;
          dropdownInstance.options.onOpenEnd = function (...args) {
            if (typeof originalOpen === "function") {
              originalOpen.apply(this, args);
            }
            setTimeout(() => {
              searchInput.focus();
              filtrarOpciones();
            }, 0);
          };

          const originalClose = dropdownInstance.options.onCloseEnd;
          dropdownInstance.options.onCloseEnd = function (...args) {
            if (typeof originalClose === "function") {
              originalClose.apply(this, args);
            }
            searchInput.value = "";
            obtenerOpciones().forEach((item) => {
              item.style.display = "";
            });
            recalcular();
          };

          dropdownInstance.__searchEnhanced = true;
        }

        if (!yaTieneBusqueda) {
          searchInput.dataset.enhanced = "true";
        }
      }

      function limpiarFormulario() {
        if (ui.formCapa) {
          ui.formCapa.reset();
        }
        if (ui.capaId) {
          ui.capaId.value = "";
        }
        limpiarTablaServicios();
        agregarFilaServicio();
        setTimeout(() => {
          refrescarCamposFormulario();
          if (ui.descripcionCapa) {
            M.textareaAutoResize(ui.descripcionCapa);
          }
        }, 0);
      }

      function limpiarTablaServicios() {
        const tablaServicios = ui.tablaServiciosBody;
        if (tablaServicios) {
          tablaServicios.innerHTML = "";
        }
      }

      function obtenerTipoServicioPorId(tipoId) {
        return tiposServicio.find(
          (item) => String(item.id) === String(tipoId)
        );
      }

      function esServicioOgc(tipoId) {
        const tipo = obtenerTipoServicioPorId(tipoId);
        if (!tipo) return false;
        return Number(tipo.id_padre) === 2;
      }

      function esServicioArcgisRest(tipoId) {
        const tipo = obtenerTipoServicioPorId(tipoId);
        if (!tipo) return false;
        const nombre = (tipo.nombre || "").toLowerCase();
        return Number(tipo.id_padre) === 3 &&
          nombre.includes("arcgis") &&
          nombre.includes("mapserver");
      }

      function requiereConexionServicio(tipoId) {
        return esServicioOgc(tipoId) || esServicioArcgisRest(tipoId);
      }

      function requiereUnicidadPorTipo(tipoId) {
        const tipo = obtenerTipoServicioPorId(tipoId);
        if (!tipo) return false;
        const padre = Number(tipo.id_padre);
        if (![2, 3].includes(padre)) return false;
        return Boolean(tipo.estado);
      }

      function asegurarParametrosUrl(url, parametros) {
        if (!url) return url;
        try {
          const urlObjeto = new URL(url);
          Object.entries(parametros).forEach(([clave, valor]) => {
            urlObjeto.searchParams.delete(clave);
            urlObjeto.searchParams.append(clave, valor);
          });
          return urlObjeto.toString();
        } catch (error) {
          let urlNormalizada = url;
          Object.entries(parametros).forEach(([clave, valor]) => {
            const expresion = new RegExp(`(${clave})=([^&]*)`, "i");
            if (expresion.test(urlNormalizada)) {
              urlNormalizada = urlNormalizada.replace(
                expresion,
                `${clave}=${valor}`
              );
            } else {
              const separador = urlNormalizada.includes("?") ? "&" : "?";
              urlNormalizada = `${urlNormalizada}${separador}${clave}=${valor}`;
            }
          });
          return urlNormalizada;
        }
      }

      function construirUrlCapabilities(tipoId, url) {
        const tipo = obtenerTipoServicioPorId(tipoId);
        if (!tipo) return url;
        const nombreTipo = (tipo.nombre || "").toLowerCase();
        if (nombreTipo.includes("wms")) {
          return asegurarParametrosUrl(url, {
            request: "GetCapabilities",
            service: "WMS",
          });
        }
        if (nombreTipo.includes("wfs")) {
          return asegurarParametrosUrl(url, {
            request: "GetCapabilities",
            service: "WFS",
          });
        }
        if (nombreTipo.includes("wmts")) {
          return asegurarParametrosUrl(url, {
            request: "GetCapabilities",
            service: "WMTS",
          });
        }
        return url;
      }

      function crearSelectTiposServicio(valorActual = "") {
        const select = document.createElement("select");
        select.className = "browser-default tipo-servicio";
        const opcionDefault = document.createElement("option");
        opcionDefault.value = "";
        opcionDefault.textContent = "Seleccione";
        select.appendChild(opcionDefault);

        tiposServicio
          .slice()
          .sort((a, b) => Number(a.id) - Number(b.id))
          .forEach((tipo) => {
            const opcion = document.createElement("option");
            opcion.value = tipo.id;
            opcion.textContent = tipo.nombre;
            if (String(tipo.id) === String(valorActual)) {
              opcion.selected = true;
            }
            select.appendChild(opcion);
          });
        return select;
      }

      function crearInputDireccion(valor = "") {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "direccion-servicio";
        input.placeholder = "URL del servicio";
        input.value = valor || "";
        input.required = true;
        return input;
      }

      function crearCampoCapaComoInput(valor = "") {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "nombre-capa-input";
        input.placeholder = "Nombre de capa";
        input.value = valor || "";
        return input;
      }

      function crearCampoCapaComoSelect(opciones = [], valorActual = "") {
        const select = document.createElement("select");
        select.className = "browser-default nombre-capa-select";
        const opcionDefault = document.createElement("option");
        opcionDefault.value = "";
        opcionDefault.textContent = "Seleccione capa";
        select.appendChild(opcionDefault);
        let seleccionAplicada = false;
        opciones.forEach((opcion) => {
          const optionElement = document.createElement("option");
          const nombreValor =
            opcion && opcion.value !== undefined ? opcion.value : "";
          const tituloValor =
            opcion && opcion.label !== undefined ? opcion.label : nombreValor;
          optionElement.value = tituloValor;
          optionElement.textContent = tituloValor;
          optionElement.dataset.titulo = tituloValor || "";
          optionElement.dataset.nombre = nombreValor;
          if (opcion && opcion.id !== undefined) {
            optionElement.dataset.id = opcion.id;
          }
          if (nombreValor) {
            optionElement.id = `${nombreValor}`;
          }
          if (
            !seleccionAplicada &&
            String(nombreValor) === String(valorActual)
          ) {
            optionElement.selected = true;
            seleccionAplicada = true;
          }
          select.appendChild(optionElement);
        });
        if (!seleccionAplicada && select.options.length > 1) {
          select.options[1].selected = true;
        }
        return select;
      }

      function setEstadoFilaServicio(fila, estado) {
        if (!fila) return;
        fila.dataset.estadoServicio = estado ? "true" : "false";
        const indicador = fila.querySelector(".estado-indicador");
        if (indicador) {
          indicador.textContent = estado ? "🟢" : "🔴";
          indicador.dataset.valor = estado ? "true" : "false";
          indicador.classList.remove("estado-indicador--oculto");
        }
      }

      function ocultarEstadoFilaServicio(fila) {
        if (!fila) return;
        fila.dataset.estadoServicio = "";
        const indicador = fila.querySelector(".estado-indicador");
        if (indicador) {
          indicador.textContent = "";
          indicador.dataset.valor = "";
          indicador.classList.add("estado-indicador--oculto");
        }
      }

      function establecerTituloCapaEnFila(fila, titulo) {
        if (!fila) return;
        fila.dataset.tituloCapa = titulo ? String(titulo) : "";
      }

      function agregarFilaServicio(servicio = {}) {
        const tablaServicios = ui.tablaServiciosBody;
        if (!tablaServicios) return;

        const fila = document.createElement("tr");
        if (servicio.id) {
          fila.dataset.servicioId = servicio.id;
        }
        fila.dataset.visible = servicio.estado === false ? "false" : "true";
        fila.dataset.tipo = servicio.id_tipo_servicio || "";
        establecerTituloCapaEnFila(fila, servicio.titulo_capa || "");
        const requiereConexion = requiereConexionServicio(
          servicio.id_tipo_servicio || ""
        );

        const celdaTipo = document.createElement("td");
        const selectTipo = crearSelectTiposServicio(
          servicio.id_tipo_servicio || ""
        );
        celdaTipo.appendChild(selectTipo);

        const celdaDireccion = document.createElement("td");
        const inputDireccion = crearInputDireccion(servicio.direccion_web || "");
        celdaDireccion.appendChild(inputDireccion);

        const celdaCapa = document.createElement("td");
        celdaCapa.className = "celda-capa";
        const opcionesIniciales = Array.isArray(servicio.opciones_capas)
          ? servicio.opciones_capas.slice()
          : [];
        if (
          !opcionesIniciales.length &&
          servicio.estado === true &&
          servicio.nombre_capa
        ) {
          opcionesIniciales.push({
            value: servicio.nombre_capa,
            label: servicio.titulo_capa || servicio.nombre_capa,
          });
        }

        if (opcionesIniciales.length) {
          fila.dataset.opcionesCapas = JSON.stringify(opcionesIniciales);
          const selectCapas = crearCampoCapaComoSelect(
            opcionesIniciales,
            servicio.nombre_capa || ""
          );
          celdaCapa.appendChild(selectCapas);
          actualizarTituloDesdeSelect(fila);
        } else {
          fila.dataset.opcionesCapas = "";
          celdaCapa.appendChild(
            crearCampoCapaComoInput(servicio.nombre_capa || "")
          );
          setEstadoFilaServicio(fila, false);
        }

        const celdaEstado = document.createElement("td");
        celdaEstado.className = "center-align";
        const spanEstado = document.createElement("span");
        spanEstado.className = "estado-indicador";
        celdaEstado.appendChild(spanEstado);

        const celdaAcciones = document.createElement("td");
        celdaAcciones.className = "center-align";
        const contenedorAcciones = document.createElement("div");
        contenedorAcciones.className = "acciones-servicio";

        const botonConectar = document.createElement("button");
        botonConectar.type = "button";
        botonConectar.className = "btn-icono btn-conectar";
        botonConectar.title = "Conectarse";
        botonConectar.innerHTML = '<i class="material-icons">sync</i>';

        const botonEliminar = document.createElement("button");
        botonEliminar.type = "button";
        botonEliminar.className = "btn-icono btn-eliminar-servicio";
        botonEliminar.title = "Eliminar";
        botonEliminar.innerHTML = '<i class="material-icons red-text">delete</i>';

        contenedorAcciones.appendChild(botonConectar);
        contenedorAcciones.appendChild(botonEliminar);
        celdaAcciones.appendChild(contenedorAcciones);

        fila.appendChild(celdaTipo);
        fila.appendChild(celdaDireccion);
        fila.appendChild(celdaCapa);
        fila.appendChild(celdaEstado);
        fila.appendChild(celdaAcciones);

        tablaServicios.appendChild(fila);

        if (typeof servicio.estado === "boolean") {
          if (servicio.estado) {
            setEstadoFilaServicio(fila, true);
          } else if (requiereConexion) {
            setEstadoFilaServicio(fila, false);
          } else {
            setEstadoFilaServicio(fila, true);
          }
        } else if (requiereConexion || !servicio.id_tipo_servicio) {
          ocultarEstadoFilaServicio(fila);
        } else {
          setEstadoFilaServicio(fila, true);
        }
      }

      function obtenerOpcionesDesdeFila(fila) {
        try {
          return fila.dataset.opcionesCapas
            ? JSON.parse(fila.dataset.opcionesCapas)
            : [];
        } catch (error) {
          return [];
        }
      }

      function actualizarCampoCapaParaFila(fila, requiereConexion) {
        const celdaCapa = fila.querySelector(".celda-capa");
        if (!celdaCapa) return;
        const valorActual = obtenerValorNombreCapa(fila);
        celdaCapa.innerHTML = "";
        if (requiereConexion) {
          const opciones = obtenerOpcionesDesdeFila(fila);
          if (opciones.length) {
            const selectCapas = crearCampoCapaComoSelect(
              opciones,
              valorActual || ""
            );
            celdaCapa.appendChild(selectCapas);
            actualizarTituloDesdeSelect(fila);
          } else {
            celdaCapa.appendChild(crearCampoCapaComoInput(valorActual || ""));
            setEstadoFilaServicio(fila, false);
          }
        } else {
          celdaCapa.appendChild(crearCampoCapaComoInput(valorActual || ""));
          fila.dataset.opcionesCapas = "";
          setEstadoFilaServicio(fila, true);
        }
      }

      function obtenerValorNombreCapa(fila) {
        const select = fila.querySelector(".nombre-capa-select");
        if (select) {
          const opcion = select.options[select.selectedIndex];
          if (opcion) {
            return opcion.dataset.nombre || opcion.id || "";
          }
          return "";
        }
        const input = fila.querySelector(".nombre-capa-input");
        return input ? input.value : "";
      }

      function actualizarTituloDesdeSelect(fila) {
        if (!fila) return;
        const select = fila.querySelector(".nombre-capa-select");
        if (!select) return;
        const opcion = select.options[select.selectedIndex];
        if (!opcion || !(opcion.dataset.nombre || opcion.value)) {
          establecerTituloCapaEnFila(fila, "");
          return;
        }
        const titulo = opcion.dataset.titulo || opcion.value || opcion.textContent || "";
        establecerTituloCapaEnFila(fila, titulo);
      }

      function obtenerTituloCapa(fila) {
        if (!fila) return "";
        const select = fila.querySelector(".nombre-capa-select");
        if (select) {
          const opcion = select.options[select.selectedIndex];
          if (!opcion) return "";
          return opcion.dataset.titulo || opcion.value || opcion.textContent || "";
        }
        return fila.dataset.tituloCapa || "";
      }

      async function conectarServicioOgc(fila) {
        const selectTipo = fila.querySelector(".tipo-servicio");
        const inputDireccion = fila.querySelector(".direccion-servicio");
        if (!selectTipo || !inputDireccion) return;

        const tipoId = selectTipo.value;
        let direccion = inputDireccion.value.trim();

        if (!tipoId) {
          M.toast({ html: "Seleccione el tipo de servicio." });
          return;
        }

        if (!direccion) {
          M.toast({ html: "Ingrese la dirección del servicio." });
          return;
        }

        const requiereConexion = requiereConexionServicio(tipoId);
        if (!requiereConexion) {
          M.toast({ html: "El servicio seleccionado no requiere conexión." });
          actualizarCampoCapaParaFila(fila, false);
          establecerTituloCapaEnFila(fila, "");
          setEstadoFilaServicio(fila, true);
          return;
        }

        if (esServicioOgc(tipoId)) {
          const direccionNormalizada = construirUrlCapabilities(tipoId, direccion);
          if (direccionNormalizada && direccionNormalizada !== direccion) {
            direccion = direccionNormalizada;
            inputDireccion.value = direccionNormalizada;
          }
        }

        ocultarEstadoFilaServicio(fila);
        try {
          const respuesta = await fetch(
            "/capas_geograficas/servicios/capabilities",
            crearOpcionesJson("POST", {
              tipo_servicio_id: tipoId,
              url: direccion,
            })
          );

          const json = await respuesta.json();
          if (!respuesta.ok || json.status !== "success") {
            throw new Error(json.message || "No se pudo obtener las capas.");
          }

          const capasDisponibles = Array.isArray(json.capas)
            ? json.capas
            : [];
          if (!capasDisponibles.length) {
            throw new Error("El servicio no devolvió capas disponibles.");
          }

          const valorAnterior = obtenerValorNombreCapa(fila) || "";
          fila.dataset.opcionesCapas = JSON.stringify(capasDisponibles);
          const celdaCapa = fila.querySelector(".celda-capa");
          if (celdaCapa) {
            celdaCapa.innerHTML = "";
            const selectCapas = crearCampoCapaComoSelect(
              capasDisponibles,
              valorAnterior
            );
            celdaCapa.appendChild(selectCapas);
            actualizarTituloDesdeSelect(fila);
          }
          const capaSeleccionada = obtenerValorNombreCapa(fila);
          if (capaSeleccionada) {
            const tituloSeleccionado = obtenerTituloCapa(fila);
            establecerTituloCapaEnFila(fila, tituloSeleccionado);
            setEstadoFilaServicio(fila, true);
          } else {
            establecerTituloCapaEnFila(fila, "");
            setEstadoFilaServicio(fila, false);
          }
          M.toast({ html: "Capas obtenidas correctamente." });
        } catch (error) {
          console.error(error);
          fila.dataset.opcionesCapas = "";
          actualizarCampoCapaParaFila(fila, true);
          establecerTituloCapaEnFila(fila, "");
          setEstadoFilaServicio(fila, false);
          M.toast({ html: error.message || "No se pudo conectar al servicio." });
        }
      }

      function obtenerServiciosDeTabla() {
        const tablaServicios = ui.tablaServiciosBody;
        if (!tablaServicios) return [];
        const filas = Array.from(tablaServicios.querySelectorAll("tr"));
        return filas
          .map((fila) => {
            const selectTipo = fila.querySelector(".tipo-servicio");
            const inputDireccion = fila.querySelector(".direccion-servicio");
            const nombreCapa = obtenerValorNombreCapa(fila);
            if (!selectTipo || !inputDireccion) {
              return null;
            }

            const tipoId = selectTipo.value;
            const direccion = inputDireccion.value.trim();
            const visible = fila.dataset.visible !== "false";
            const idServicio = fila.dataset.servicioId
              ? Number(fila.dataset.servicioId)
              : null;
            const camposVacios =
              !tipoId && !direccion && !(nombreCapa && nombreCapa.trim());
            if (camposVacios && !idServicio) {
              return null;
            }

            actualizarTituloDesdeSelect(fila);
            const tituloCapa = obtenerTituloCapa(fila).trim();
            const requiereConexion = requiereConexionServicio(tipoId);
            const estadoRegistro = fila.dataset.estadoServicio || "";
            let estado = true;
            if (requiereConexion) {
              if (estadoRegistro === "true") {
                estado = true;
              } else {
                estado = false;
              }
            }

            return {
              id: idServicio,
              tipo_servicio_id: tipoId ? Number(tipoId) : null,
              direccion: direccion,
              nombre_capa: nombreCapa ? nombreCapa.trim() : "",
              titulo_capa: tituloCapa,
              estado,
              visible,
            };
          })
          .filter((item) => item !== null);
      }

      function validarServicios(servicios) {
        const tiposUnicos = new Set();
        for (const servicio of servicios) {
          const tipoId = servicio.tipo_servicio_id;
          if (!tipoId) {
            M.toast({ html: "Cada servicio debe tener un tipo seleccionado." });
            return false;
          }
          if (!servicio.direccion) {
            M.toast({ html: "Cada servicio debe tener una dirección." });
            return false;
          }

          if (requiereUnicidadPorTipo(tipoId)) {
            if (tiposUnicos.has(tipoId)) {
              M.toast({
                html: "Solo puede registrar una capa por cada tipo de servicio.",
              });
              return false;
            }
            tiposUnicos.add(tipoId);
          }

          const requiereConexion = requiereConexionServicio(tipoId);
          if (!requiereConexion) {
            continue;
          }

          const esArcgis = esServicioArcgisRest(tipoId);
          const estado = Boolean(servicio.estado);
          if (estado) {
            if (!servicio.nombre_capa) {
              const mensaje = esArcgis
                ? "Seleccione el identificador de la capa del servicio ArcGIS MapServer."
                : "Seleccione el nombre de la capa del servicio OGC.";
              M.toast({ html: mensaje });
              return false;
            }
            if (!servicio.titulo_capa) {
              const mensaje = esArcgis
                ? "Seleccione el nombre de la capa del servicio ArcGIS MapServer."
                : "Seleccione el título de la capa del servicio OGC.";
              M.toast({ html: mensaje });
              return false;
            }
          } else if (!servicio.nombre_capa) {
            const mensaje = esArcgis
              ? "Indique el identificador de la capa cuando el servicio ArcGIS MapServer no está activo."
              : "Indique el nombre de la capa cuando el servicio OGC no está activo.";
            M.toast({ html: mensaje });
            return false;
          }
        }
        return true;
      }

      async function cargarServiciosDeCapa(capaId) {
        limpiarTablaServicios();
        try {
          const respuesta = await fetch(`/capas_geograficas/detalle/${capaId}`);
          if (!respuesta.ok) {
            throw new Error("No se pudo obtener el detalle de la capa.");
          }
          const json = await respuesta.json();
          const servicios = Array.isArray(json.servicios) ? json.servicios : [];
          if (!servicios.length) {
            agregarFilaServicio();
          } else {
            servicios.forEach((servicio) => {
              agregarFilaServicio({
                id: servicio.id,
                id_tipo_servicio: servicio.id_tipo_servicio,
                direccion_web: servicio.direccion_web,
                nombre_capa: servicio.nombre_capa,
                titulo_capa: servicio.titulo_capa,
                estado:
                  servicio.estado === false
                    ? false
                    : Boolean(servicio.estado),
              });
            });
          }
        } catch (error) {
          console.error(error);
          M.toast({ html: error.message || "Error al cargar servicios." });
          agregarFilaServicio();
        }
      }

      function cerrarModal() {
        if (modalInstance) {
          modalInstance.close();
        }
      }

      function abrirModalParaNueva() {
        limpiarFormulario();
        if (ui.modalTituloCapa) {
          ui.modalTituloCapa.textContent = "NUEVA CAPA GEOGRÁFICA";
        }
        if (!modalInstance) {
          inicializarComponentesBase();
        }
        if (modalInstance) {
          modalInstance.open();
        }
      }

      async function abrirModalParaEditar(capa) {
        limpiarFormulario();
        if (ui.modalTituloCapa) {
          ui.modalTituloCapa.textContent = "EDITAR CAPA GEOGRÁFICA";
        }
        if (ui.capaId) {
          ui.capaId.value = capa.id;
        }
        if (ui.nombreCapa) {
          ui.nombreCapa.value = capa.nombre || "";
        }
        if (ui.descripcionCapa) {
          ui.descripcionCapa.value = capa.descripcion || "";
        }
        if (ui.tipoCapaModal) {
          ui.tipoCapaModal.value = String(capa.tipo_capa || "");
        }
        if (ui.publicarGeoperu) {
          ui.publicarGeoperu.checked = !!capa.en_geoperu;
        }
        if (ui.categoriaCapa) {
          ui.categoriaCapa.value = capa.id_categoria || "";
        }
        if (ui.institucionCapa) {
          ui.institucionCapa.value = capa.id_institucion || "";
        }
        await cargarServiciosDeCapa(capa.id);
        setTimeout(() => {
          refrescarCamposFormulario();
          if (ui.descripcionCapa) {
            M.textareaAutoResize(ui.descripcionCapa);
          }
        }, 0);
        if (!modalInstance) {
          inicializarComponentesBase();
        }
        if (modalInstance) {
          modalInstance.open();
        }
      }

      function renderTabla(data) {
        const tabla = ui.tablaCapasBody;
        if (!tabla) {
          return;
        }
        tabla.innerHTML = "";
        if (!data.length) {
          const fila = document.createElement("tr");
          const celda = document.createElement("td");
          celda.colSpan = 6;
          celda.textContent = "No hay capas registradas.";
          fila.appendChild(celda);
          tabla.appendChild(fila);
          return;
        }

        data.forEach((capa, index) => {
          const fila = document.createElement("tr");
          const nombre = escaparHtml(capa.nombre || "");
          const categoria = escaparHtml(capa.categoria || "");
          const institucion = escaparHtml(capa.institucion_sigla || "");
          const serviciosDetalle = Array.isArray(capa.servicios_detalle)
            ? capa.servicios_detalle
            : [];

          let serviciosHtml = "";
          if (serviciosDetalle.length) {
            serviciosHtml = serviciosDetalle
              .map((servicio) => {
                const nombreServicio = escaparHtml(servicio.nombre || "");
                let claseEstado = "servicio-badge--sin-estado";
                let tituloEstado = "Estado no especificado";
                if (servicio.estado === true) {
                  claseEstado = "servicio-badge--activo";
                  tituloEstado = "Servicio activo";
                } else if (servicio.estado === false) {
                  claseEstado = "servicio-badge--inactivo";
                  tituloEstado = "Servicio inactivo";
                }
                return `<span class="servicio-badge ${claseEstado}" title="${tituloEstado}">${nombreServicio}</span>`;
              })
              .join("");
          }

          let serviciosContenido = "";
          if (serviciosHtml) {
            serviciosContenido = `<div class="servicios-listado">${serviciosHtml}</div>`;
          } else if (capa.servicios) {
            serviciosContenido = escaparHtml(capa.servicios);
          } else {
            serviciosContenido =
              "<span class=\"grey-text text-darken-1\">Sin servicios</span>";
          }

          fila.innerHTML = `
            <td style="padding-left:20px;">${index + 1}</td>
            <td>${nombre}</td>
            <td>${categoria}</td>
            <td>${institucion}</td>
            <td>${serviciosContenido}</td>
            <td class="col-opciones">
              <img
                src="${iconoEditar}"
                class="icono-tabla accion-actualizar"
                data-action="actualizar"
                data-id="${capa.id}"
                alt="Actualizar"
                title="Actualizar"
              />
              <img
                src="${iconoEliminar}"
                class="icono-tabla accion-eliminar"
                data-action="eliminar"
                data-id="${capa.id}"
                alt="Eliminar"
                title="Eliminar"
              />
            </td>
          `;
          tabla.appendChild(fila);
        });
      }

      async function cargarCapas() {
        try {
          const respuesta = await fetch("/capas_geograficas/listar");
          const json = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(
              json && json.message
                ? json.message
                : "No se pudo obtener la lista de capas."
            );
          }
          capasCache = {
            activos: Array.isArray(json.activos) ? json.activos : [],
            inactivos: Array.isArray(json.inactivos) ? json.inactivos : [],
            sin_estado: Array.isArray(json.sin_estado) ? json.sin_estado : [],
          };
          capas = []
            .concat(capasCache.activos)
            .concat(capasCache.inactivos)
            .concat(capasCache.sin_estado);
          aplicarFiltros();
        } catch (error) {
          console.error(error);
          M.toast({ html: error.message || "Error al cargar las capas." });
        }
      }

      function aplicarFiltros() {
        const filtroNombre = (ui.txtBuscarNombre?.value || "")
          .toLowerCase()
          .trim();
        const filtroTipoServicio = ui.filtroTipoServicio
          ? ui.filtroTipoServicio.value
          : "";

        const switchEstados = ui.switchEstados;
        const mostrarActivos = switchEstados ? switchEstados.checked : true;

        let base = mostrarActivos
          ? (capasCache.activos || []).slice()
          : (capasCache.inactivos || []).slice();
        base = base.concat(capasCache.sin_estado || []);

        const filtradas = base.filter((capa) => {
          const coincideNombre = capa.nombre
            ? capa.nombre.toLowerCase().includes(filtroNombre)
            : false;
          const coincideServicio = filtroTipoServicio
            ? Array.isArray(capa.servicio_ids) &&
              capa.servicio_ids.some(
                (idServicio) =>
                  String(idServicio) === String(filtroTipoServicio)
              )
            : true;
          return coincideNombre && coincideServicio;
        });

        renderTabla(filtradas);
      }

      function escaparHtml(texto) {
        const div = document.createElement("div");
        div.textContent = texto;
        return div.innerHTML;
      }

      async function guardarCapa() {
        const id = ui.capaId ? ui.capaId.value || null : null;
        const nombre = ui.nombreCapa ? ui.nombreCapa.value.trim() : "";
        const descripcion = ui.descripcionCapa
          ? ui.descripcionCapa.value.trim()
          : "";
        const tipoCapa = ui.tipoCapaModal ? ui.tipoCapaModal.value : "";
        const publicar = ui.publicarGeoperu
          ? ui.publicarGeoperu.checked
          : false;
        const categoriaId = ui.categoriaCapa ? ui.categoriaCapa.value : "";
        const institucionId = ui.institucionCapa
          ? ui.institucionCapa.value
          : "";

        if (!nombre || !tipoCapa || !categoriaId || !institucionId) {
          M.toast({ html: "Complete los campos obligatorios." });
          return;
        }

        const servicios = obtenerServiciosDeTabla();
        if (!validarServicios(servicios)) {
          return;
        }

        const payload = {
          id,
          nombre,
          descripcion,
          tipo_capa: tipoCapa,
          publicar_geoperu: publicar,
          categoria_id: categoriaId,
          institucion_id: institucionId,
          servicios,
        };

        try {
          const respuesta = await fetch(
            "/capas_geograficas/guardar",
            crearOpcionesJson("POST", payload)
          );
          const json = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(json.message || "No se pudo guardar la capa.");
          }
          M.toast({ html: "Capa guardada correctamente." });
          cerrarModal();
          await cargarCapas();
        } catch (error) {
          console.error(error);
          M.toast({ html: error.message || "Error al guardar la capa." });
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        ui.tablaCapasBody = document.querySelector("#tablaCapas tbody");
        ui.tablaServiciosBody = document.querySelector("#tablaServicios tbody");
        ui.btnBuscar = document.getElementById("btnBuscar");
        ui.txtBuscarNombre = document.getElementById("txtBuscarNombre");
        ui.filtroTipoServicio = document.getElementById("filtroTipoServicio");
        ui.switchEstados = document.getElementById("switchEstados");
        ui.btnAgregar = document.getElementById("btnAgregar");
        ui.btnGuardar = document.getElementById("btnGuardar");
        ui.modalCapa = document.getElementById("modalCapa");
        ui.modalTituloCapa = document.getElementById("modalTituloCapa");
        ui.formCapa = document.getElementById("formCapa");
        ui.capaId = document.getElementById("capaId");
        ui.nombreCapa = document.getElementById("nombre_capa");
        ui.descripcionCapa = document.getElementById("descripcion_capa");
        ui.tipoCapaModal = document.getElementById("tipo_capa_modal");
        ui.publicarGeoperu = document.getElementById("publicar_geoperu");
        ui.categoriaCapa = document.getElementById("categoria_capa");
        ui.institucionCapa = document.getElementById("institucion_capa");
        ui.btnAddServicio = document.getElementById("btnAddServicio");
        ui.imgCloseModalLayer = document.getElementById("imgClose_modal_layer");
        ui.institucionTag = document.getElementById("institucionTag");

        inicializarComponentesBase();
        cargarCapas();

        if (ui.btnAgregar) {
          ui.btnAgregar.addEventListener("click", abrirModalParaNueva);
        }

        if (ui.imgCloseModalLayer) {
          ui.imgCloseModalLayer.style.cursor = "pointer";
          ui.imgCloseModalLayer.addEventListener("click", cerrarModal);
        }

        if (ui.btnGuardar) {
          ui.btnGuardar.addEventListener("click", guardarCapa);
        }

        if (ui.btnAddServicio) {
          ui.btnAddServicio.addEventListener("click", () => {
            agregarFilaServicio();
          });
        }

        if (ui.btnBuscar) {
          ui.btnBuscar.addEventListener("click", aplicarFiltros);
        }

        if (ui.txtBuscarNombre) {
          ui.txtBuscarNombre.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
              aplicarFiltros();
            }
          });
        }

        if (ui.filtroTipoServicio) {
          ui.filtroTipoServicio.addEventListener("change", aplicarFiltros);
        }

        if (ui.switchEstados) {
          ui.switchEstados.addEventListener("change", aplicarFiltros);
        }

        const tablaCapasBody = ui.tablaCapasBody;
        if (tablaCapasBody) {
          tablaCapasBody.addEventListener("click", async (event) => {
            const accion = event.target.closest("img[data-action]");
            if (!accion) return;
            const id = accion.getAttribute("data-id");
            const tipo = accion.getAttribute("data-action");
            const capa = capas.find((item) => String(item.id) === String(id));
            if (!capa) return;
            if (tipo === "actualizar") {
              await abrirModalParaEditar(capa);
            } else if (tipo === "eliminar") {
              M.toast({ html: "La eliminación se habilitará próximamente." });
            }
          });
        }

        const tablaServiciosBody = ui.tablaServiciosBody;
        if (tablaServiciosBody) {
          tablaServiciosBody.addEventListener("change", (event) => {
            const fila = event.target.closest("tr");
            if (!fila) return;
            if (event.target.classList.contains("tipo-servicio")) {
              const tipoId = event.target.value;
              fila.dataset.tipo = tipoId || "";
              establecerTituloCapaEnFila(fila, "");
              const requiereConexion = requiereConexionServicio(tipoId);
              if (requiereConexion) {
                fila.dataset.opcionesCapas = "";
              }
              actualizarCampoCapaParaFila(fila, requiereConexion);
              if (!tipoId) {
                ocultarEstadoFilaServicio(fila);
              } else if (!requiereConexion) {
                setEstadoFilaServicio(fila, true);
              } else {
                ocultarEstadoFilaServicio(fila);
              }
            } else if (event.target.classList.contains("nombre-capa-select")) {
              actualizarTituloDesdeSelect(fila);
              const tipoId = fila.querySelector(".tipo-servicio")?.value;
              if (requiereConexionServicio(tipoId)) {
                const seleccion = obtenerValorNombreCapa(fila);
                if (seleccion) {
                  setEstadoFilaServicio(fila, true);
                } else {
                  setEstadoFilaServicio(fila, false);
                }
              }
            } else if (event.target.classList.contains("nombre-capa-input")) {
              const tipoId = fila.querySelector(".tipo-servicio")?.value;
              establecerTituloCapaEnFila(fila, "");
              if (requiereConexionServicio(tipoId)) {
                setEstadoFilaServicio(fila, false);
              }
            }
          });

          tablaServiciosBody.addEventListener("click", (event) => {
            const fila = event.target.closest("tr");
            if (!fila) return;

            if (event.target.closest(".btn-conectar")) {
              conectarServicioOgc(fila);
              return;
            }

            if (event.target.closest(".btn-eliminar-servicio")) {
              fila.remove();
              if (!tablaServiciosBody.querySelector("tr")) {
                agregarFilaServicio();
              }
            }
          });
        }

        if (ui.descripcionCapa) {
          ui.descripcionCapa.addEventListener("input", () => {
            M.textareaAutoResize(ui.descripcionCapa);
          });
        }
      });
    </script>
  </body>
</html>
