<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GEOIDEP | Personal</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <style>
      .tabla-gestion {
        background-color: #fff;
        width: 100%;
      }

      .tabla-gestion th,
      .tabla-gestion td {
        vertical-align: middle;
        word-break: break-word;
      }

      .icono-accion {
        width: 28px;
        height: 28px;
        cursor: pointer;
        margin-right: 8px;
      }

      .seccion-gestion {
        margin-bottom: 40px;
      }
    </style>
  </head>
  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <div class="seccion-gestion">
          <div class="row">
            <div class="col s12">
              <h4>Personas</h4>
              <p class="grey-text text-darken-1">
                Registra al personal disponible y asigna usuarios cuando
                corresponda.
              </p>
            </div>
            <div class="col s12 right-align" style="margin-bottom: 20px">
              <button
                class="btn waves-effect green"
                id="btnNuevaPersona"
                type="button"
              >
                <i class="material-icons left">add</i>Nuevo
              </button>
            </div>
          </div>
          <div class="row">
            <div class="col s12">
              <table class="highlight tabla-gestion" id="tablaPersonas">
                <thead>
                  <tr>
                    <th style="width: 70px">N°</th>
                    <th>Número de documento</th>
                    <th>Nombres y apellidos</th>
                    <th>Celular</th>
                    <th style="width: 200px">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal persona -->
    <div id="modalPersona" class="modal">
      <div class="modal-content">
        <h5 id="tituloModalPersona">Nueva persona</h5>
        <form id="formPersona">
          <div class="row">
            <div class="input-field col s12 m6">
              <select id="persona_tipo_documento" required>
                <option value="" disabled selected>
                  Seleccione tipo de documento
                </option>
                {% for tipo in tipos_documento %}
                <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                {% endfor %}
              </select>
              <label>Tipo de documento</label>
            </div>
            <div class="input-field col s12 m6">
              <input
                id="persona_numero_documento"
                type="text"
                maxlength="20"
                required
              />
              <label for="persona_numero_documento">Número de documento</label>
            </div>
            <div class="input-field col s12">
              <input
                id="persona_nombres"
                type="text"
                maxlength="255"
                required
              />
              <label for="persona_nombres">Nombres y apellidos</label>
            </div>
            <div class="input-field col s12">
              <input id="persona_celular" type="text" maxlength="20" />
              <label for="persona_celular">Celular</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-flat modal-close" type="button">Cancelar</button>
        <button class="btn blue" id="btnGuardarPersona" type="button">
          Guardar
        </button>
      </div>
    </div>

    <div id="modalConfirmacion" class="modal">
      <div class="modal-content">
        <h6 id="mensajeConfirmacion">¿Desea continuar?</h6>
      </div>
      <div class="modal-footer">
        <button class="btn-flat modal-close" type="button">Cancelar</button>
        <button class="btn red" id="btnConfirmarEliminar" type="button">
          Eliminar
        </button>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
    <script>
      const iconoEditar =
        "{{ url_for('static', filename='images/editar.png') }}";
      const iconoEliminar =
        "{{ url_for('static', filename='images/eliminar.png') }}";
      const iconoDetalle =
        "{{ url_for('static', filename='images/detalles.png') }}";

      const ui = {
        personas: {
          tabla: null,
          modal: null,
          btnNuevo: null,
          btnGuardar: null,
          campos: {},
        },
        confirmacion: {
          modal: null,
          mensaje: null,
          btnConfirmar: null,
        },
      };

      const estado = {
        personas: [],
        personaEditandoId: null,
        elementoAEliminar: null,
      };

      function obtenerCookie(nombre) {
        const prefijo = `${nombre}=`;
        const partes = document.cookie ? document.cookie.split("; ") : [];
        for (const parte of partes) {
          if (parte.startsWith(prefijo)) {
            return decodeURIComponent(parte.slice(prefijo.length));
          }
        }
        return null;
      }

      function crearOpcionesJson(method, payload) {
        const headers = {};
        const token = obtenerCookie("csrf_access_token");
        if (token) {
          headers["X-CSRF-Token"] = token;
        }
        const opciones = { method, headers };
        if (payload !== undefined) {
          headers["Content-Type"] = "application/json";
          opciones.body = JSON.stringify(payload);
        }
        return opciones;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const tablaPersonas = document.querySelector("#tablaPersonas tbody");
        if (tablaPersonas) {
          ui.personas.tabla = tablaPersonas;
        }

        const modalPersonaElemento = document.querySelector("#modalPersona");
        if (modalPersonaElemento) {
          ui.personas.modal = M.Modal.init(modalPersonaElemento);
        }

        ui.personas.btnNuevo = document.getElementById("btnNuevaPersona");
        ui.personas.btnGuardar = document.getElementById("btnGuardarPersona");
        ui.personas.campos = {
          tipo_documento: document.getElementById("persona_tipo_documento"),
          numero_documento: document.getElementById("persona_numero_documento"),
          nombres: document.getElementById("persona_nombres"),
          celular: document.getElementById("persona_celular"),
        };

        const modalConfirmacionElemento =
          document.querySelector("#modalConfirmacion");
        if (modalConfirmacionElemento) {
          ui.confirmacion.modal = M.Modal.init(modalConfirmacionElemento);
        }
        ui.confirmacion.mensaje = document.getElementById(
          "mensajeConfirmacion"
        );
        ui.confirmacion.btnConfirmar = document.getElementById(
          "btnConfirmarEliminar"
        );

        M.FormSelect.init(document.querySelectorAll("select"));

        if (ui.personas.btnNuevo) {
          ui.personas.btnNuevo.addEventListener("click", () =>
            abrirModalPersona()
          );
        }
        if (ui.personas.btnGuardar) {
          ui.personas.btnGuardar.addEventListener("click", guardarPersona);
        }
        if (ui.personas.tabla) {
          ui.personas.tabla.addEventListener("click", manejarTablaPersonas);
        }

        if (ui.confirmacion.btnConfirmar) {
          ui.confirmacion.btnConfirmar.addEventListener(
            "click",
            confirmarEliminacion
          );
        }

        cargarPersonas();
      });

      async function cargarPersonas() {
        if (!ui.personas.tabla) {
          return;
        }
        ui.personas.tabla.innerHTML =
          '<tr><td colspan="5" class="center-align">Cargando...</td></tr>';
        try {
          const respuesta = await fetch("/personal/personas");
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(
              data.message || "No se pudo cargar la información."
            );
          }
          estado.personas = data.personas || [];
          renderPersonas();
        } catch (error) {
          console.error(error);
          ui.personas.tabla.innerHTML =
            '<tr><td colspan="5" class="center-align">Ocurrió un error al cargar los datos.</td></tr>';
          M.toast({ html: "Error al cargar las personas." });
        }
      }

      function renderPersonas() {
        if (!ui.personas.tabla) {
          return;
        }
        if (!estado.personas.length) {
          ui.personas.tabla.innerHTML =
            '<tr><td colspan="5" class="center-align">No hay registros.</td></tr>';
          return;
        }

        ui.personas.tabla.innerHTML = estado.personas
          .map((item, indice) => {
            const acciones = [];
            if (!item.tiene_usuario) {
              acciones.push(
                `<img src="${iconoDetalle}" alt="Asignar usuario" class="icono-accion accion-asignar" data-id="${item.id}" data-contexto="persona" title="Asignar usuario" />`
              );
            }
            acciones.push(
              `<img src="${iconoEditar}" alt="Editar" class="icono-accion accion-editar" data-id="${item.id}" data-contexto="persona" />`
            );
            acciones.push(
              `<img src="${iconoEliminar}" alt="Eliminar" class="icono-accion accion-eliminar" data-id="${item.id}" data-contexto="persona" />`
            );
            return `
              <tr>
                <td>${indice + 1}</td>
                <td>${item.numero_documento || ""}</td>
                <td>${item.nombres_apellidos || ""}</td>
                <td>${item.celular || ""}</td>
                <td>${acciones.join("")}</td>
              </tr>
            `;
          })
          .join("");
      }

      function abrirModalPersona(registro = null) {
        if (!ui.personas.modal) {
          return;
        }
        estado.personaEditandoId = registro ? registro.id : null;
        const titulo = document.getElementById("tituloModalPersona");
        if (titulo) {
          titulo.textContent = registro ? "Editar persona" : "Nueva persona";
        }
        ui.personas.campos.tipo_documento.value = registro
          ? String(registro.id_tipo_documento || "")
          : "";
        ui.personas.campos.numero_documento.value = registro
          ? registro.numero_documento || ""
          : "";
        ui.personas.campos.nombres.value = registro
          ? registro.nombres_apellidos || ""
          : "";
        ui.personas.campos.celular.value = registro
          ? registro.celular || ""
          : "";
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll("select"));
        ui.personas.modal.open();
      }

      function manejarTablaPersonas(evento) {
        const objetivo = evento.target;
        if (objetivo.dataset.contexto !== "persona") {
          return;
        }
        const id = Number(objetivo.dataset.id);
        if (objetivo.classList.contains("accion-editar")) {
          const persona = estado.personas.find((item) => item.id === id);
          if (!persona) {
            M.toast({ html: "Persona no encontrada." });
            return;
          }
          abrirModalPersona(persona);
        } else if (objetivo.classList.contains("accion-eliminar")) {
          estado.elementoAEliminar = id;
          if (ui.confirmacion.mensaje) {
            ui.confirmacion.mensaje.textContent =
              "¿Desea eliminar a la persona seleccionada?";
          }
          if (ui.confirmacion.modal) {
            ui.confirmacion.modal.open();
          }
        } else if (objetivo.classList.contains("accion-asignar")) {
          M.toast({
            html: "La asignación de usuario se implementará próximamente.",
          });
        }
      }

      async function guardarPersona() {
        const tipoDocumento = ui.personas.campos.tipo_documento.value;
        const numeroDocumento =
          ui.personas.campos.numero_documento.value.trim();
        const nombres = ui.personas.campos.nombres.value.trim();
        const celular = ui.personas.campos.celular.value.trim();

        if (!tipoDocumento || !numeroDocumento || !nombres) {
          M.toast({ html: "Complete tipo de documento, número y nombres." });
          return;
        }

        const payload = {
          id_tipo_documento: tipoDocumento,
          numero_documento: numeroDocumento,
          nombres_apellidos: nombres,
          celular,
        };
        const url = estado.personaEditandoId
          ? `/personal/personas/${estado.personaEditandoId}`
          : "/personal/personas";
        const metodo = estado.personaEditandoId ? "PUT" : "POST";

        try {
          const respuesta = await fetch(
            url,
            crearOpcionesJson(metodo, payload)
          );
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(
              data.message || "No se pudo guardar la información."
            );
          }
          M.toast({ html: data.message || "Operación exitosa." });
          estado.personaEditandoId = null;
          if (ui.personas.modal) {
            ui.personas.modal.close();
          }
          cargarPersonas();
        } catch (error) {
          M.toast({
            html: error.message || "Error al guardar la información.",
          });
        }
      }

      async function confirmarEliminacion() {
        const id = estado.elementoAEliminar;
        if (!id) {
          if (ui.confirmacion.modal) {
            ui.confirmacion.modal.close();
          }
          return;
        }

        try {
          const respuesta = await fetch(
            `/personal/personas/${id}`,
            crearOpcionesJson("DELETE")
          );
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(data.message || "No se pudo eliminar el registro.");
          }
          M.toast({
            html: data.message || "Registro eliminado correctamente.",
          });
          cargarPersonas();
        } catch (error) {
          M.toast({ html: error.message || "Error al eliminar el registro." });
        } finally {
          estado.elementoAEliminar = null;
          if (ui.confirmacion.modal) {
            ui.confirmacion.modal.close();
          }
        }
      }
    </script>
  </body>
</html>
