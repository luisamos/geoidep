<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GEOIDEP | Personal</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/materialize.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <style>
      .tabla-gestion {
        background-color: #fff;
        width: 100%;
      }

      .tabla-gestion th,
      .tabla-gestion td {
        vertical-align: middle;
        word-break: break-word;
      }

      .icono-accion {
        width: 28px;
        height: 28px;
        cursor: pointer;
        margin-right: 8px;
      }

      .seccion-gestion {
        margin-bottom: 40px;
      }
    </style>
  </head>
  <body>
    <div id="menu">{% include 'gestion/izquierda.html' %}</div>

    <div class="contenido">
      <div class="container">
        <div class="seccion-gestion">
          <div class="row">
            <div class="col s12">
              <h4>Catálogo de personal</h4>
              <p class="grey-text text-darken-1">
                Define los tipos de personal disponibles para clasificación.
              </p>
            </div>
            <div class="col s12 right-align" style="margin-bottom: 20px">
              <button
                class="btn waves-effect green"
                id="btnNuevoCatalogo"
                type="button"
              >
                <i class="material-icons left">add</i>Nuevo
              </button>
            </div>
          </div>
          <div class="row">
            <div class="col s12">
              <table class="highlight tabla-gestion" id="tablaCatalogo">
                <thead>
                  <tr>
                    <th style="width: 70px">N°</th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Sigla</th>
                    <th style="width: 160px">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="seccion-gestion">
          <div class="row">
            <div class="col s12">
              <h4>Personas</h4>
              <p class="grey-text text-darken-1">
                Registra al personal disponible y asigna usuarios cuando
                corresponda.
              </p>
            </div>
            <div class="col s12 right-align" style="margin-bottom: 20px">
              <button
                class="btn waves-effect green"
                id="btnNuevaPersona"
                type="button"
              >
                <i class="material-icons left">add</i>Nuevo
              </button>
            </div>
          </div>
          <div class="row">
            <div class="col s12">
              <table class="highlight tabla-gestion" id="tablaPersonas">
                <thead>
                  <tr>
                    <th style="width: 70px">N°</th>
                    <th>Número de documento</th>
                    <th>Nombres y apellidos</th>
                    <th>Celular</th>
                    <th style="width: 200px">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal catálogo -->
    <div id="modalCatalogo" class="modal">
      <div class="modal-content">
        <h5 id="tituloModalCatalogo">Nuevo registro</h5>
        <form id="formCatalogo">
          <div class="row">
            <div class="input-field col s12 m6">
              <input id="catalogo_codigo" type="text" maxlength="50" required />
              <label for="catalogo_codigo">Código</label>
            </div>
            <div class="input-field col s12 m6">
              <input id="catalogo_sigla" type="text" maxlength="100" required />
              <label for="catalogo_sigla">Sigla</label>
            </div>
            <div class="input-field col s12">
              <input
                id="catalogo_nombre"
                type="text"
                maxlength="255"
                required
              />
              <label for="catalogo_nombre">Nombre</label>
            </div>
            <div class="input-field col s12">
              <textarea
                id="catalogo_descripcion"
                class="materialize-textarea"
                maxlength="1000"
              ></textarea>
              <label for="catalogo_descripcion">Descripción</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-flat modal-close" type="button">Cancelar</button>
        <button class="btn blue" id="btnGuardarCatalogo" type="button">
          Guardar
        </button>
      </div>
    </div>

    <!-- Modal persona -->
    <div id="modalPersona" class="modal">
      <div class="modal-content">
        <h5 id="tituloModalPersona">Nueva persona</h5>
        <form id="formPersona">
          <div class="row">
            <div class="input-field col s12 m6">
              <select id="persona_tipo_documento" required>
                <option value="" disabled selected>
                  Seleccione tipo de documento
                </option>
                {% for tipo in tipos_documento %}
                <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                {% endfor %}
              </select>
              <label>Tipo de documento</label>
            </div>
            <div class="input-field col s12 m6">
              <input
                id="persona_numero_documento"
                type="text"
                maxlength="20"
                required
              />
              <label for="persona_numero_documento">Número de documento</label>
            </div>
            <div class="input-field col s12">
              <input
                id="persona_nombres"
                type="text"
                maxlength="255"
                required
              />
              <label for="persona_nombres">Nombres y apellidos</label>
            </div>
            <div class="input-field col s12">
              <input id="persona_celular" type="text" maxlength="20" />
              <label for="persona_celular">Celular</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-flat modal-close" type="button">Cancelar</button>
        <button class="btn blue" id="btnGuardarPersona" type="button">
          Guardar
        </button>
      </div>
    </div>

    <div id="modalConfirmacion" class="modal">
      <div class="modal-content">
        <h6 id="mensajeConfirmacion">¿Desea continuar?</h6>
      </div>
      <div class="modal-footer">
        <button class="btn-flat modal-close" type="button">Cancelar</button>
        <button class="btn red" id="btnConfirmarEliminar" type="button">
          Eliminar
        </button>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/materialize.min.js') }}"></script>
    <script>
      const iconoEditar =
        "{{ url_for('static', filename='images/editar.png') }}";
      const iconoEliminar =
        "{{ url_for('static', filename='images/eliminar.png') }}";
      const iconoDetalle =
        "{{ url_for('static', filename='images/detalles.png') }}";

      const ui = {
        catalogo: {
          tabla: null,
          modal: null,
          btnNuevo: null,
          btnGuardar: null,
          campos: {},
        },
        personas: {
          tabla: null,
          modal: null,
          btnNuevo: null,
          btnGuardar: null,
          campos: {},
        },
        confirmacion: {
          modal: null,
          mensaje: null,
          btnConfirmar: null,
        },
      };

      const estado = {
        catalogo: [],
        personas: [],
        catalogoEditandoId: null,
        personaEditandoId: null,
        elementoAEliminar: null,
        tipoEliminacion: null,
      };

      function obtenerCookie(nombre) {
        const prefijo = `${nombre}=`;
        const partes = document.cookie ? document.cookie.split("; ") : [];
        for (const parte of partes) {
          if (parte.startsWith(prefijo)) {
            return decodeURIComponent(parte.slice(prefijo.length));
          }
        }
        return null;
      }

      function crearOpcionesJson(method, payload) {
        const headers = {};
        const token = obtenerCookie("csrf_access_token");
        if (token) {
          headers["X-CSRF-Token"] = token;
        }
        const opciones = { method, headers };
        if (payload !== undefined) {
          headers["Content-Type"] = "application/json";
          opciones.body = JSON.stringify(payload);
        }
        return opciones;
      }

      document.addEventListener("DOMContentLoaded", () => {
        ui.catalogo.tabla = document.querySelector("#tablaCatalogo tbody");
        ui.catalogo.modal = M.Modal.init(
          document.querySelector("#modalCatalogo")
        );
        ui.catalogo.btnNuevo = document.getElementById("btnNuevoCatalogo");
        ui.catalogo.btnGuardar = document.getElementById("btnGuardarCatalogo");
        ui.catalogo.campos = {
          codigo: document.getElementById("catalogo_codigo"),
          nombre: document.getElementById("catalogo_nombre"),
          sigla: document.getElementById("catalogo_sigla"),
          descripcion: document.getElementById("catalogo_descripcion"),
        };

        ui.personas.tabla = document.querySelector("#tablaPersonas tbody");
        ui.personas.modal = M.Modal.init(
          document.querySelector("#modalPersona")
        );
        ui.personas.btnNuevo = document.getElementById("btnNuevaPersona");
        ui.personas.btnGuardar = document.getElementById("btnGuardarPersona");
        ui.personas.campos = {
          tipo_documento: document.getElementById("persona_tipo_documento"),
          numero_documento: document.getElementById("persona_numero_documento"),
          nombres: document.getElementById("persona_nombres"),
          celular: document.getElementById("persona_celular"),
        };

        ui.confirmacion.modal = M.Modal.init(
          document.querySelector("#modalConfirmacion")
        );
        ui.confirmacion.mensaje = document.getElementById(
          "mensajeConfirmacion"
        );
        ui.confirmacion.btnConfirmar = document.getElementById(
          "btnConfirmarEliminar"
        );

        M.FormSelect.init(document.querySelectorAll("select"));
        const descripcionTextarea = document.getElementById(
          "catalogo_descripcion"
        );
        if (descripcionTextarea) {
          M.textareaAutoResize(descripcionTextarea);
        }

        if (ui.catalogo.btnNuevo) {
          ui.catalogo.btnNuevo.addEventListener("click", () =>
            abrirModalCatalogo()
          );
        }
        if (ui.catalogo.btnGuardar) {
          ui.catalogo.btnGuardar.addEventListener("click", guardarCatalogo);
        }
        if (ui.catalogo.tabla) {
          ui.catalogo.tabla.addEventListener("click", manejarTablaCatalogo);
        }

        if (ui.personas.btnNuevo) {
          ui.personas.btnNuevo.addEventListener("click", () =>
            abrirModalPersona()
          );
        }
        if (ui.personas.btnGuardar) {
          ui.personas.btnGuardar.addEventListener("click", guardarPersona);
        }
        if (ui.personas.tabla) {
          ui.personas.tabla.addEventListener("click", manejarTablaPersonas);
        }

        if (ui.confirmacion.btnConfirmar) {
          ui.confirmacion.btnConfirmar.addEventListener(
            "click",
            confirmarEliminacion
          );
        }

        cargarCatalogo();
        cargarPersonas();
      });

      async function cargarCatalogo() {
        if (!ui.catalogo.tabla) {
          return;
        }
        ui.catalogo.tabla.innerHTML =
          '<tr><td colspan="5" class="center-align">Cargando...</td></tr>';
        try {
          const respuesta = await fetch("/personal/catalogo");
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(
              data.message || "No se pudo cargar la información."
            );
          }
          estado.catalogo = data.catalogo || [];
          renderCatalogo();
        } catch (error) {
          console.error(error);
          ui.catalogo.tabla.innerHTML =
            '<tr><td colspan="5" class="center-align">Ocurrió un error al cargar los datos.</td></tr>';
          M.toast({ html: "Error al cargar el catálogo." });
        }
      }

      function renderCatalogo() {
        if (!ui.catalogo.tabla) {
          return;
        }
        if (!estado.catalogo.length) {
          ui.catalogo.tabla.innerHTML =
            '<tr><td colspan="5" class="center-align">No hay registros.</td></tr>';
          return;
        }
        ui.catalogo.tabla.innerHTML = estado.catalogo
          .map((item, indice) => {
            const acciones = `
              <img src="${iconoEditar}" alt="Editar" class="icono-accion accion-editar" data-id="${item.id}" data-contexto="catalogo" />
              <img src="${iconoEliminar}" alt="Eliminar" class="icono-accion accion-eliminar" data-id="${item.id}" data-contexto="catalogo" />
            `;
            return `
              <tr>
                <td>${indice + 1}</td>
                <td>${item.codigo || ""}</td>
                <td>${item.nombre || ""}</td>
                <td>${item.sigla || ""}</td>
                <td>${acciones}</td>
              </tr>
            `;
          })
          .join("");
      }

      function abrirModalCatalogo(registro = null) {
        estado.catalogoEditandoId = registro ? registro.id : null;
        document.getElementById("tituloModalCatalogo").textContent = registro
          ? "Editar registro"
          : "Nuevo registro";
        ui.catalogo.campos.codigo.value = registro ? registro.codigo || "" : "";
        ui.catalogo.campos.nombre.value = registro ? registro.nombre || "" : "";
        ui.catalogo.campos.sigla.value = registro ? registro.sigla || "" : "";
        ui.catalogo.campos.descripcion.value = registro
          ? registro.descripcion || ""
          : "";
        M.updateTextFields();
        M.textareaAutoResize(ui.catalogo.campos.descripcion);
        ui.catalogo.modal.open();
      }

      function manejarTablaCatalogo(evento) {
        const objetivo = evento.target;
        if (objetivo.dataset.contexto !== "catalogo") {
          return;
        }
        const id = Number(objetivo.dataset.id);
        if (objetivo.classList.contains("accion-editar")) {
          const registro = estado.catalogo.find((item) => item.id === id);
          if (!registro) {
            M.toast({ html: "Registro no encontrado." });
            return;
          }
          abrirModalCatalogo(registro);
        } else if (objetivo.classList.contains("accion-eliminar")) {
          estado.elementoAEliminar = id;
          estado.tipoEliminacion = "catalogo";
          ui.confirmacion.mensaje.textContent =
            "¿Desea eliminar el registro del catálogo?";
          ui.confirmacion.modal.open();
        }
      }

      async function guardarCatalogo() {
        const codigo = ui.catalogo.campos.codigo.value.trim();
        const nombre = ui.catalogo.campos.nombre.value.trim();
        const sigla = ui.catalogo.campos.sigla.value.trim();
        const descripcion = ui.catalogo.campos.descripcion.value.trim();

        if (!codigo || !nombre || !sigla) {
          M.toast({ html: "Complete código, nombre y sigla." });
          return;
        }

        const payload = { codigo, nombre, sigla, descripcion };
        const url = estado.catalogoEditandoId
          ? `/personal/catalogo/${estado.catalogoEditandoId}`
          : "/personal/catalogo";
        const metodo = estado.catalogoEditandoId ? "PUT" : "POST";

        try {
          const respuesta = await fetch(
            url,
            crearOpcionesJson(metodo, payload)
          );
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(data.message || "No se pudo guardar el registro.");
          }
          M.toast({ html: data.message || "Operación exitosa." });
          estado.catalogoEditandoId = null;
          ui.catalogo.modal.close();
          cargarCatalogo();
        } catch (error) {
          M.toast({
            html: error.message || "Error al guardar la información.",
          });
        }
      }

      async function cargarPersonas() {
        if (!ui.personas.tabla) {
          return;
        }
        ui.personas.tabla.innerHTML =
          '<tr><td colspan="5" class="center-align">Cargando...</td></tr>';
        try {
          const respuesta = await fetch("/personal/personas");
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(
              data.message || "No se pudo cargar la información."
            );
          }
          estado.personas = data.personas || [];
          renderPersonas();
        } catch (error) {
          console.error(error);
          ui.personas.tabla.innerHTML =
            '<tr><td colspan="5" class="center-align">Ocurrió un error al cargar los datos.</td></tr>';
          M.toast({ html: "Error al cargar las personas." });
        }
      }

      function renderPersonas() {
        if (!ui.personas.tabla) {
          return;
        }
        if (!estado.personas.length) {
          ui.personas.tabla.innerHTML =
            '<tr><td colspan="5" class="center-align">No hay registros.</td></tr>';
          return;
        }

        ui.personas.tabla.innerHTML = estado.personas
          .map((item, indice) => {
            const acciones = [];
            if (!item.tiene_usuario) {
              acciones.push(
                `<img src="${iconoDetalle}" alt="Asignar usuario" class="icono-accion accion-asignar" data-id="${item.id}" data-contexto="persona" title="Asignar usuario" />`
              );
            }
            acciones.push(
              `<img src="${iconoEditar}" alt="Editar" class="icono-accion accion-editar" data-id="${item.id}" data-contexto="persona" />`
            );
            acciones.push(
              `<img src="${iconoEliminar}" alt="Eliminar" class="icono-accion accion-eliminar" data-id="${item.id}" data-contexto="persona" />`
            );
            return `
              <tr>
                <td>${indice + 1}</td>
                <td>${item.numero_documento || ""}</td>
                <td>${item.nombres_apellidos || ""}</td>
                <td>${item.celular || ""}</td>
                <td>${acciones.join("")}</td>
              </tr>
            `;
          })
          .join("");
      }

      function abrirModalPersona(registro = null) {
        estado.personaEditandoId = registro ? registro.id : null;
        document.getElementById("tituloModalPersona").textContent = registro
          ? "Editar persona"
          : "Nueva persona";
        ui.personas.campos.tipo_documento.value = registro
          ? String(registro.id_tipo_documento || "")
          : "";
        ui.personas.campos.numero_documento.value = registro
          ? registro.numero_documento || ""
          : "";
        ui.personas.campos.nombres.value = registro
          ? registro.nombres_apellidos || ""
          : "";
        ui.personas.campos.celular.value = registro
          ? registro.celular || ""
          : "";
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll("select"));
        ui.personas.modal.open();
      }

      function manejarTablaPersonas(evento) {
        const objetivo = evento.target;
        if (objetivo.dataset.contexto !== "persona") {
          return;
        }
        const id = Number(objetivo.dataset.id);
        if (objetivo.classList.contains("accion-editar")) {
          const persona = estado.personas.find((item) => item.id === id);
          if (!persona) {
            M.toast({ html: "Persona no encontrada." });
            return;
          }
          abrirModalPersona(persona);
        } else if (objetivo.classList.contains("accion-eliminar")) {
          estado.elementoAEliminar = id;
          estado.tipoEliminacion = "persona";
          ui.confirmacion.mensaje.textContent =
            "¿Desea eliminar a la persona seleccionada?";
          ui.confirmacion.modal.open();
        } else if (objetivo.classList.contains("accion-asignar")) {
          M.toast({
            html: "La asignación de usuario se implementará próximamente.",
          });
        }
      }

      async function guardarPersona() {
        const tipoDocumento = ui.personas.campos.tipo_documento.value;
        const numeroDocumento =
          ui.personas.campos.numero_documento.value.trim();
        const nombres = ui.personas.campos.nombres.value.trim();
        const celular = ui.personas.campos.celular.value.trim();

        if (!tipoDocumento || !numeroDocumento || !nombres) {
          M.toast({ html: "Complete tipo de documento, número y nombres." });
          return;
        }

        const payload = {
          id_tipo_documento: tipoDocumento,
          numero_documento: numeroDocumento,
          nombres_apellidos: nombres,
          celular,
        };
        const url = estado.personaEditandoId
          ? `/personal/personas/${estado.personaEditandoId}`
          : "/personal/personas";
        const metodo = estado.personaEditandoId ? "PUT" : "POST";

        try {
          const respuesta = await fetch(
            url,
            crearOpcionesJson(metodo, payload)
          );
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(
              data.message || "No se pudo guardar la información."
            );
          }
          M.toast({ html: data.message || "Operación exitosa." });
          estado.personaEditandoId = null;
          ui.personas.modal.close();
          cargarPersonas();
        } catch (error) {
          M.toast({
            html: error.message || "Error al guardar la información.",
          });
        }
      }

      async function confirmarEliminacion() {
        const id = estado.elementoAEliminar;
        const tipo = estado.tipoEliminacion;
        if (!id || !tipo) {
          ui.confirmacion.modal.close();
          return;
        }

        const url =
          tipo === "catalogo"
            ? `/personal/catalogo/${id}`
            : `/personal/personas/${id}`;

        try {
          const respuesta = await fetch(url, crearOpcionesJson("DELETE"));
          const data = await respuesta.json();
          if (!respuesta.ok) {
            throw new Error(data.message || "No se pudo eliminar el registro.");
          }
          M.toast({
            html: data.message || "Registro eliminado correctamente.",
          });
          if (tipo === "catalogo") {
            cargarCatalogo();
          } else {
            cargarPersonas();
          }
        } catch (error) {
          M.toast({ html: error.message || "Error al eliminar el registro." });
        } finally {
          estado.elementoAEliminar = null;
          estado.tipoEliminacion = null;
          ui.confirmacion.modal.close();
        }
      }
    </script>
  </body>
</html>
