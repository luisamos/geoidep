<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='imagenes/favicon-peru.ico') }}"
    />
  <title>
    Geoportal IDEP
  </title>
  <script src="{{ url_for('static', filename='js/browser@4.js') }}"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/all.min.css') }}"
  />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
  </style>
</head>

<body topmargin="0" leftmargin="0">

{% include 'geoportal/cabecera.html' %}

<form name="frm_buscar_catalogo" id="frm_buscar_catalogo" method="get" action="{{ catalogo_url }}">
  <input type="hidden" name="search_token" value="{{ search_token }}" />
  <section class="bg-[#EEF3FB]">
    <div class="max-w-screen-xl mx-auto px-6 pt-[62px] pb-[62px]">
      <h2 class="text-black text-center [font-feature-settings:'liga'_off,'clig'_off] text-[32px] md:text-[36px] leading-[40px] font-bold">
        Catálogo Nacional de Servicios Georeferenciados
      </h2>

      <p class="mb-8 mt-2 max-w-[820px] mx-auto text-black text-center text-[16px] leading-[24px] font-normal">
        Acceso a los recursos geoespaciales de la Infraestructura de Datos Espaciales del Perú.
      </p>

      <div class="space-y-4 md:space-y-0 md:grid md:grid-cols-3 md:gap-6">

        <div class="md:col-span-3">
          <div class="flex items-center border-2 border-[#26292E] rounded-[8px] bg-white px-2">
            <input
              type="text"
              id="texto_busqueda" name="filter_terms"
              value="{{ filter_terms or '' }}"
              placeholder="Buscar Geoportales, Visores, Metadatos, Servicios de mapas"
              class="flex-1 h-12 px-3 bg-transparent placeholder-gray-400 outline-none ring-0 focus:outline-none focus:ring-0 focus:border-transparent"
            />
            <button type="submit"
              class="flex items-center justify-center h-10 w-10 bg-[#26292E] rounded-[6px] hover:bg-black transition outline-none ring-0 focus:outline-none focus:ring-0"
              aria-label="Buscar">
              <i class="fas fa-search text-white text-base"></i>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2" for="tipos_servicios">Tipos de servicios</label>
          <div class="relative">
            <select name="tipos_servicios" id="tipos_servicios"
              class="w-full h-12 pr-10 pl-3 bg-white border-2 border-[#26292E] rounded-[8px] appearance-none outline-none ring-0 focus:outline-none focus:ring-0">
              <option value="" disabled {% if not selected_tipo %}selected{% endif %}>[Elegir]</option>
              {% for tipo in tipos_servicios %}
              <option value="{{ tipo.slug|lower }}" {% if selected_tipo and tipo.id == selected_tipo.id %}selected{% endif %}>{{ tipo.nombre|upper }}</option>
              {% endfor %}
            </select>
            <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2">
              <i class="fa-solid fa-chevron-down text-[#26292E] text-xs"></i>
            </span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2" for="categoria">Categoría</label>
          <div class="relative">
            <select name="id_categoria" id="categoria"
              class="w-full h-12 pr-10 pl-3 bg-white border-2 border-[#26292E] rounded-[8px] appearance-none outline-none ring-0 focus:outline-none focus:ring-0 {% if not selected_tipo %}bg-gray-100 cursor-not-allowed{% endif %}"
              {% if not selected_tipo %}disabled{% endif %}>
              <option value="" disabled {% if not selected_categoria_id %}selected{% endif %}>[Elegir]</option>
              {% for categoria in categorias_opciones %}
              <option value="{{ categoria.id }}" {% if selected_categoria_id == categoria.id %}selected{% endif %}>{{ categoria.nombre|upper }}</option>
              {% endfor %}
            </select>
            <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2">
              <i class="fa-solid fa-chevron-down text-[#26292E] text-xs"></i>
            </span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2" for="entidad">Entidad</label>
          <div class="relative">
            <select name="id_institucion" id="entidad"
              class="w-full h-12 pr-10 pl-3 bg-white border-2 border-[#26292E] rounded-[8px] appearance-none outline-none ring-0 focus:outline-none focus:ring-0 {% if not selected_tipo %}bg-gray-100 cursor-not-allowed{% endif %}"
              {% if not selected_tipo %}disabled{% endif %}>
              <option value="" disabled {% if not selected_institucion_id %}selected{% endif %}>[Elegir]</option>
              {% for institucion in instituciones_opciones %}
              <option value="{{ institucion.id }}" {% if selected_institucion_id == institucion.id %}selected{% endif %}>{{ institucion.nombre|upper }}</option>
              {% endfor %}
            </select>
            <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2">
              <i class="fa-solid fa-chevron-down text-[#26292E] text-xs"></i>
            </span>
          </div>
        </div>

        <div class="md:col-span-3">
          <div class="flex items-start gap-3">
            <span class="shrink-0 text-sm font-semibold text-[#0B1221] leading-5">Filtros aplicados:</span>
            <div class="flex flex-wrap items-center gap-2 flex-1" id="filters-container">
              <div class="flex flex-wrap items-center gap-2" aria-live="polite">
                {% if applied_filters %}
                  {% for filtro in applied_filters %}
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full border border-[#BFCBDE] bg-white text-xs font-semibold text-[#184397]">{{ filtro|upper }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-sm text-gray-500">Sin filtros aplicados</span>
                {% endif %}
              </div>
              <button id="clear-filters"
                type="button"
                class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold border border-transparent {% if clear_filters_enabled %}text-[#184397] hover:underline{% else %}text-gray-400 cursor-not-allowed{% endif %}"
                {% if not clear_filters_enabled %}disabled aria-disabled="true"{% endif %}>
                <i class="fa-solid fa-trash"></i>
                Borrar filtros
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</form>

<section class="bg-white">
  <div class="max-w-screen-xl mx-auto px-6 mt-[42px] pb-16">
    {% if selected_tipo %}
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <p class="text-[16px] leading-[24px] font-semibold text-black">
        <span id="resCount">{{ total_herramientas }}</span> Resultados encontrados
      </p>
    </div>
    {% endif %}

    <div class="mt-8 space-y-12">
      {% if categorias %}
        {% for categoria in categorias %}
        <div class="space-y-6">
          <div>
            <h4 class="text-[20px] font-semibold text-[#0B1221]">{{ categoria.nombre|upper }}</h4>
          </div>
          <div class="space-y-8">
            {% for herramienta in categoria.herramientas %}
            <article class="rounded-2xl bg-white shadow-[0_12px_40px_rgba(0,0,0,0.08)] overflow-hidden border border-transparent md:border-r-[6px] {% if herramienta.estado_is_active %}md:border-r-[#16A34A]{% else %}md:border-r-[#DC2626]{% endif %}">
              <div class="grid md:grid-cols-[220px_1fr]">
                <div class="relative flex justify-center items-center bg-gray-50 p-4 md:p-0 md:block">
                  <img src="{{ herramienta.imagen_url }}" alt="Vista previa" class="w-[140px] h-[220px] object-cover rounded-xl md:rounded-none md:absolute md:inset-0 md:w-full md:h-full" />
                </div>
                <div class="flex flex-col p-6 md:p-8 gap-5">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <span class="inline-flex items-center justify-center gap-1 px-2 py-[2px] rounded-[4px] text-[12px] leading-[20px] font-bold {% if herramienta.estado_is_active %}border border-[#16A34A] text-[#166534] bg-[#F0FDF4]{% else %}border border-[#DC2626] text-[#991B1B] bg-[#FEF2F2]{% endif %}">
                      {{ herramienta.estado_label|upper }}
                    </span>
                    <span class="inline-flex items-center justify-center gap-1 px-2 py-[2px] rounded-[4px] border border-[#BFCBDE] bg-[#F6F6FF] text-[12px] leading-[20px] font-bold text-[#331980]">
                      {{ (herramienta.institucion or 'Institución no disponible')|upper }}
                    </span>
                  </div>

                  <h4 class="text-[18px] font-semibold text-[#184397] underline decoration-transparent hover:decoration-current transition">
                    {{ herramienta.nombre }}
                  </h4>

                  {% if herramienta.descripcion %}
                  <p class="text-[14px] leading-6 text-gray-800">{{ herramienta.descripcion }}</p>
                  {% endif %}

                  {% if herramienta.es_capa %}
                  <div class="space-y-4">
                    {% if herramienta.servicios %}
                    <div class="flex flex-wrap gap-2">
                      {% for servicio in herramienta.servicios %}
                      {% set sigla_servicio = servicio.sigla or 'SERVICIO' %}
                      <span class="inline-flex items-center justify-center gap-1 px-2 py-[2px] rounded-[6px] text-[12px] leading-[20px] font-bold {% if servicio.estado_is_active %}border border-[#16A34A] text-[#166534] bg-[#F0FDF4]{% else %}border border-[#DC2626] text-[#991B1B] bg-[#FEF2F2]{% endif %}">
                        {{ sigla_servicio }}
                      </span>
                      {% endfor %}
                    </div>
                    <div class="space-y-4">
                      {% for servicio in herramienta.servicios %}
                      {% set sigla_servicio = servicio.sigla or 'SERVICIO' %}
                      <div class="rounded-2xl border border-[#E2E8F0] bg-[#F8FAFC] p-4 space-y-3">
                        <div class="flex flex-col gap-1">
                          <p class="text-sm font-semibold text-[#0B1221]">{{ servicio.etiqueta or 'Recurso disponible' }}</p>
                          {% if servicio.recurso %}
                          <p class="text-xs text-gray-600 break-words">{{ servicio.recurso }}</p>
                          {% endif %}
                        </div>
                        {% if servicio.estado_is_active %}
                        <div class="flex flex-wrap gap-3">
                          {% if servicio.view_map_url %}
                          <a href="{{ servicio.view_map_url }}" target="_blank" rel="noopener noreferrer"
                            class="inline-flex items-center gap-2 rounded-[8px] border-2 border-[#184397] text-[#184397] font-semibold px-4 py-2 hover:bg-[#184397] hover:text-white transition">
                            <i class="fa-solid fa-map-location-dot text-sm"></i>
                            <span>Ver mapa</span>
                          </a>
                          {% endif %}
                          {% if servicio.copy_url %}
                          <button type="button"
                            class="inline-flex items-center gap-2 rounded-[8px] border-2 border-[#0F172A] text-[#0F172A] font-semibold px-4 py-2 hover:bg-[#0F172A] hover:text-white transition js-copy-url"
                            data-copy-url="{{ servicio.copy_url }}" data-copy-label="{{ sigla_servicio }}">
                            <i class="fa-solid fa-link text-sm"></i>
                            <span class="js-copy-button-text">Copiar URL {{ sigla_servicio }}</span>
                          </button>
                          {% endif %}
                          {% if servicio.ir_servicio_url %}
                          <a href="{{ servicio.ir_servicio_url }}" target="_blank" rel="noopener noreferrer"
                            class="inline-flex items-center gap-2 rounded-[8px] border-2 border-[#0B7A75] text-[#0B7A75] font-semibold px-4 py-2 hover:bg-[#0B7A75] hover:text-white transition">
                            <i class="fa-solid fa-arrow-up-right-from-square text-sm"></i>
                            <span>Ir al servicio</span>
                          </a>
                          {% endif %}
                        </div>
                        {% else %}
                        <p class="text-xs italic text-gray-500">Recurso no disponible.</p>
                        {% endif %}
                      </div>
                      {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-600">No se registraron servicios geográficos para esta capa.</p>
                    {% endif %}
                  </div>
                  {% else %}
                  <div class="space-y-2 text-[14px] text-black">
                    <p>
                      <span class="font-semibold">Tipo de servicios:</span>
                      {{ (herramienta.tipo_servicio or 'Sin registro')|upper }}
                    </p>
                    {% if herramienta.institucion %}
                    <p>
                      <span class="font-semibold">Recurso:</span>
                      {{ herramienta.recurso }}
                    </p>
                    {% endif %}
                  </div>
                  <div class="pt-2">
                    {% if herramienta.estado_is_active and herramienta.recurso %}
                    <a href="{{ herramienta.recurso }}" target="_blank" rel="noopener noreferrer"
                      class="inline-flex w-max items-center gap-2 rounded-[8px] border-2 border-[#184397] text-[#184397] font-semibold px-8 py-[14px] hover:bg-[#184397] hover:text-white transition">
                      <i class="fa-solid fa-arrow-up-right-from-square text-sm"></i>
                      <span>Acceso al recurso</span>
                    </a>
                    {% else %}
                    <span class="inline-flex w-max items-center gap-2 rounded-[8px] border-2 border-[#9CA3AF] text-[#9CA3AF] font-semibold px-8 py-[14px] cursor-not-allowed">
                      <i class="fa-solid fa-arrow-up-right-from-square text-sm"></i>
                      <span>Acceso al recurso</span>
                    </span>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </article>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      {% elif selected_tipo %}
        <div class="text-center py-12 border border-dashed border-[#BFCBDE] rounded-2xl">
          <p class="text-[16px] text-gray-600">No se encontraron resultados para los filtros seleccionados.</p>
        </div>
      {% else %}
        <div class="text-center py-12 border border-dashed border-[#BFCBDE] rounded-2xl">
          <p class="text-[16px] text-gray-600">Selecciona un tipo de servicio para ver los resultados disponibles.</p>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% include 'geoportal/pie_pagina.html' %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const baseCatalogUrl = '{{ catalogo_url }}';
    const serviceSelect = document.getElementById('tipos_servicios');
    const categorySelect = document.getElementById('categoria');
    const institutionSelect = document.getElementById('entidad');
    const searchInput = document.getElementById('texto_busqueda');
    const clearButton = document.getElementById('clear-filters');
    const searchTokenInput = document.querySelector('input[name="search_token"]');

    function buildUrl() {
      const slug = serviceSelect.value;
      const params = new URLSearchParams();

      if (categorySelect.value) {
        params.set('id_categoria', categorySelect.value);
      }

      if (institutionSelect.value) {
        params.set('id_institucion', institutionSelect.value);
      }

      const searchValue = searchInput.value.trim();
      if (searchValue) {
        params.set('filter_terms', searchValue);
      }

      if (searchTokenInput && searchTokenInput.value && searchValue) {
        params.set('search_token', searchTokenInput.value);
      }

      let url = baseCatalogUrl;
      if (slug) {
        url = `${baseCatalogUrl}/${slug}`;
      }

      const queryString = params.toString();
      if (queryString) {
        url += `?${queryString}`;
      }

      return url;
    }

    function navigateWithFilters(event) {
      if (event) {
        event.preventDefault();
      }
      const destination = buildUrl();
      window.location.href = destination;
    }

    if (serviceSelect) {
      serviceSelect.addEventListener('change', navigateWithFilters);
    }

    if (categorySelect) {
      categorySelect.addEventListener('change', navigateWithFilters);
    }

    if (institutionSelect) {
      institutionSelect.addEventListener('change', navigateWithFilters);
    }

    const form = document.getElementById('frm_buscar_catalogo');
    if (form) {
      form.addEventListener('submit', navigateWithFilters);
    }

    if (clearButton) {
      clearButton.addEventListener('click', function () {
        if (clearButton.hasAttribute('disabled')) {
          return;
        }
        window.location.href = baseCatalogUrl;
      });
    }

    function setCopyFeedback(button, successText) {
      if (!button) {
        return;
      }
      const textContainer = button.querySelector('.js-copy-button-text');
      if (!textContainer) {
        return;
      }
      if (!textContainer.dataset.originalText) {
        textContainer.dataset.originalText = textContainer.textContent.trim();
      }
      textContainer.textContent = successText || 'Copiado';
      button.classList.add('copied');
      window.setTimeout(() => {
        textContainer.textContent = textContainer.dataset.originalText || 'Copiar URL';
        button.classList.remove('copied');
      }, 2000);
    }

    async function copiarAlPortapapeles(url) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(url);
        return true;
      }
      const temporal = document.createElement('input');
      temporal.type = 'text';
      temporal.value = url;
      temporal.setAttribute('aria-hidden', 'true');
      temporal.style.position = 'absolute';
      temporal.style.opacity = '0';
      document.body.appendChild(temporal);
      temporal.select();
      let exito = false;
      try {
        exito = document.execCommand('copy');
      } catch (error) {
        console.error('No se pudo copiar la URL.', error);
        exito = false;
      }
      document.body.removeChild(temporal);
      return exito;
    }

    const copyButtons = document.querySelectorAll('.js-copy-url');
    copyButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const url = button.getAttribute('data-copy-url');
        if (!url) {
          return;
        }
        const label = button.getAttribute('data-copy-label');
        const successText = label ? `Copiado ${label}` : 'Copiado';
        try {
          const resultado = await copiarAlPortapapeles(url);
          if (resultado) {
            setCopyFeedback(button, successText);
          }
        } catch (error) {
          console.error('Error al copiar la URL.', error);
        }
      });
    });
  });
</script>
</body>
</html>